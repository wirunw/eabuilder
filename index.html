<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="สร้างสถาปัตยกรรมองค์กรอัจฉริยะด้วย AI ผ่าน 6 ขั้นตอนการทำงานแบบครบวงจร">
    <meta name="keywords" content="Enterprise Architecture, EA, OpenAI GPT-5.2 mini, Workflow Builder, AI EA Tool">
    <meta name="author" content="เภสัชกรวิรุณ เวชศิริ">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.netlify.app/">
    <meta property="og:title" content="EA Flow Builder - Enterprise Architecture Workflow">
    <meta property="og:description" content="สร้างสถาปัตยกรรมองค์กรอัจฉริยะด้วย AI ผ่าน 6 ขั้นตอนการทำงานแบบครบวงจร">
    <meta property="og:image" content="https://your-domain.netlify.app/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-domain.netlify.app/">
    <meta property="twitter:title" content="EA Flow Builder - Enterprise Architecture Workflow">
    <meta property="twitter:description" content="สร้างสถาปัตยกรรมองค์กรอัจฉริยะด้วย AI ผ่าน 6 ขั้นตอนการทำงานแบบครบวงจร">
    <meta property="twitter:image" content="https://your-domain.netlify.app/og-image.png">

    <title>EA Flow Builder - Enterprise Architecture Workflow</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192x192.png?v=20241221">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512x512.png?v=20241221">
    <link rel="apple-touch-icon" href="./icon-192x192.png?v=20241221">
    <meta name="theme-color" content="#dc2626">
    
    <!-- Google Fonts: Sarabun + Inter for better readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS core utilities -->
    <link rel="stylesheet" href="./tailwind.min.css">
    <!-- Tailwind CSS Inline Styles (No CDN) -->
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="config.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Tailwind CSS Base Classes */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1 1 0%; }
        .flex-none { flex: none; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        
        .w-10 { width: 2.5rem; }
        .w-12 { width: 3rem; }
        .w-80 { width: 20rem; }
        .w-full { width: 100%; }
        .h-10 { height: 2.5rem; }
        .h-12 { height: 3rem; }
        .h-16 { height: 4rem; }
        .h-1 { height: 0.25rem; }
        .min-h-screen { min-height: 100vh; }
        
        .max-w-4xl { max-width: 56rem; }
        .max-w-5xl { max-width: 64rem; }
        .max-w-7xl { max-width: 80rem; }
        
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .px-8 { padding-left: 2rem; padding-right: 2rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-1\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .pt-6 { padding-top: 1.5rem; }
        .pt-8 { padding-top: 2rem; }
        .pt-12 { padding-top: 3rem; }
        .pb-2 { padding-bottom: 0.5rem; }
        .pb-6 { padding-bottom: 1.5rem; }
        
        .m-1 { margin: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-8 { margin-top: 2rem; }
        .mt-12 { margin-top: 3rem; }
        
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .text-7xl { font-size: 4.5rem; line-height: 1; }
        
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        
        .text-gray-100 { color: #f3f4f6; }
        .text-gray-200 { color: #e5e7eb; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-900 { color: #111827; }
        .text-red-600 { color: #dc2626; }
        .text-red-700 { color: #b91c1c; }
        .text-red-800 { color: #991b1b; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-blue-800 { color: #1e40af; }
        .text-green-600 { color: #059669; }
        .text-green-700 { color: #047857; }
        .text-green-800 { color: #065f46; }
        .text-yellow-500 { color: #eab308; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-rose-500 { color: #f43f5e; }
        .text-rose-600 { color: #e11d48; }
        .text-rose-700 { color: #be123c; }
        .text-rose-800 { color: #9f1239; }
        .text-cyan-600 { color: #0891b2; }
        .text-cyan-700 { color: #0e7490; }
        .text-cyan-800 { color: #155e75; }
        .text-purple-600 { color: #9333ea; }
        .text-purple-700 { color: #7c3aed; }
        .text-purple-800 { color: #6b21a8; }
        .text-white { color: #ffffff; }
        
        .bg-white { background-color: #ffffff; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-gray-300 { background-color: #d1d5db; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-red-100 { background-color: #fee2e2; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-red-700 { background-color: #b91c1c; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-green-500 { background-color: #10b981; }
        .bg-green-600 { background-color: #059669; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-yellow-100 { background-color: #fef3c7; }
        .bg-yellow-500 { background-color: #eab308; }
        .bg-yellow-600 { background-color: #ca8a04; }
        .bg-rose-50 { background-color: #fff1f2; }
        .bg-rose-100 { background-color: #ffe4e6; }
        .bg-rose-500 { background-color: #f43f5e; }
        .bg-rose-600 { background-color: #e11d48; }
        .bg-cyan-50 { background-color: #ecfeff; }
        .bg-cyan-100 { background-color: #cffafe; }
        .bg-cyan-500 { background-color: #06b6d4; }
        .bg-cyan-600 { background-color: #0891b2; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-100 { background-color: #ede9fe; }
        .bg-purple-500 { background-color: #8b5cf6; }
        .bg-purple-600 { background-color: #7c3aed; }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(59 130 246 / 0)); }
        .from-red-600 { --tw-gradient-from: #dc2626; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(220 38 38 / 0)); }
        .from-red-700 { --tw-gradient-from: #b91c1c; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(185 28 28 / 0)); }
        .from-rose-100 { --tw-gradient-from: #ffe4e6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(255 228 230 / 0)); }
        .from-rose-200 { --tw-gradient-from: #fecdd3; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(254 205 211 / 0)); }
        .from-pink-100 { --tw-gradient-from: #fdf2f8; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(253 242 248 / 0)); }
        .to-blue-600 { --tw-gradient-to: #2563eb; }
        .to-orange-100 { --tw-gradient-to: #ffedd5; }
        .to-purple-600 { --tw-gradient-to: #7c3aed; }
        .to-violet-50 { --tw-gradient-to: #f5f3ff; }
        .to-gray-100 { --tw-gradient-to: #f3f4f6; }
        
        .border { border-width: 1px; }
        .border-0 { border-width: 0px; }
        .border-2 { border-width: 2px; }
        .border-b { border-bottom-width: 1px; }
        .border-t { border-top-width: 1px; }
        .border-l-4 { border-left-width: 4px; }
        .border-r { border-right-width: 1px; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-blue-100 { border-color: #dbeafe; }
        .border-blue-200 { border-color: #bfdbfe; }
        .border-blue-300 { border-color: #93c5fd; }
        .border-green-100 { border-color: #dcfce7; }
        .border-green-200 { border-color: #bbf7d0; }
        .border-yellow-100 { border-color: #fef3c7; }
        .border-yellow-200 { border-color: #fde68a; }
        .border-yellow-400 { border-color: #facc15; }
        .border-rose-100 { border-color: #ffe4e6; }
        .border-rose-200 { border-color: #fecdd3; }
        .border-cyan-100 { border-color: #cffafe; }
        .border-cyan-200 { border-color: #a5f3fc; }
        .border-purple-100 { border-color: #ede9fe; }
        .border-purple-200 { border-color: #ddd6fe; }
        .border-red-200 { border-color: #fecaca; }
        .border-fuchsia-200 { border-color: #f5d0fe; }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-3xl { border-radius: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded { border-radius: 0.25rem; }
        
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .sticky { position: sticky; }
        .top-0 { top: 0px; }
        .fixed { position: fixed; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .z-10 { z-index: 10; }
        .z-20 { z-index: 20; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-y-scroll { overflow-y: scroll; }
        
        .transform { transform: translateX(var(--tw-translate-x), translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
        .scale-105 { --tw-scale-x: 1.05; --tw-scale-y: 1.05; }
        .scale-110 { --tw-scale-x: 1.1; --tw-scale-y: 1.1; }
        .scale-102 { --tw-scale-x: 1.02; --tw-scale-y: 1.02; }
        .-translate-x-100 { --tw-translate-x: -100%; }
        .translate-y-0 { --tw-translate-y: 0px; }
        .translate-x-0 { --tw-translate-x: 0px; }
        .-translate-y-1 { --tw-translate-y: -0.25rem; }
        .-translate-y-4 { --tw-translate-y: -1rem; }
        .-translate-y-30 { --tw-translate-y: -7.5rem; }
        
        .transition-all { transition-property: all; }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; }
        .transition-transform { transition-property: transform; }
        .duration-300 { transition-duration: 300ms; }
        .duration-500 { transition-duration: 500ms; }
        .duration-700 { transition-duration: 700ms; }
        .ease { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        
        .hover\:scale-105:hover { --tw-scale-x: 1.05; --tw-scale-y: 1.05; }
        .hover\:scale-110:hover { --tw-scale-x: 1.1; --tw-scale-y: 1.1; }
        .hover\:scale-102:hover { --tw-scale-x: 1.02; --tw-scale-y: 1.02; }
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .hover\:bg-blue-50:hover { background-color: #eff6ff; }
        .hover\:bg-green-50:hover { background-color: #f0fdf4; }
        .hover\:bg-yellow-50:hover { background-color: #fefce8; }
        .hover\:bg-rose-50:hover { background-color: #fff1f2; }
        .hover\:bg-cyan-50:hover { background-color: #ecfeff; }
        .hover\:bg-purple-50:hover { background-color: #faf5ff; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .hover\:bg-yellow-600:hover { background-color: #ca8a04; }
        .hover\:bg-rose-600:hover { background-color: #e11d48; }
        .hover\:bg-cyan-600:hover { background-color: #0891b2; }
        .hover\:bg-purple-600:hover { background-color: #7c3aed; }
        .hover\:bg-green-600:hover { background-color: #059669; }
        .hover\:bg-fuchsia-200:hover { background-color: #f5d0fe; }
        .hover\:text-blue-600:hover { color: #2563eb; }
        .hover\:text-red-600:hover { color: #dc2626; }
        .hover\:text-gray-800:hover { color: #1f2937; }
        .hover\:text-gray-700:hover { color: #374151; }
        .hover\:border-fuchsia-200:hover { border-color: #f5d0fe; }
        .hover\:border-fuchsia-300:hover { border-color: #e879f9; }
        .hover\:border-blue-300:hover { border-color: #93c5fd; }
        .hover\:border-red-200:hover { border-color: #fecaca; }
        
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .focus\:ring-2:focus { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        .focus\:ring-blue-300:focus { --tw-ring-color: #93c5fd; }
        .focus\:ring-offset-1:focus { --tw-ring-offset-width: 2px; }
        
        .md\:flex { display: flex; }
        .md\:translate-x-0 { --tw-translate-x: 0px; }
        .md\:block { display: block; }
        .md\:inline { display: inline; }
        .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .md\:w-1\/3 { width: 33.333333%; }
        .md\:w-2\/3 { width: 66.666667%; }
        .md\:col-span-2 { grid-column: span 2 / span 2; }
        
        .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .lg\:inline { display: inline; }
        
        .sm\:flex { display: flex; }
        .sm\:px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .sm\:py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .sm\:flex-row { flex-direction: row; }
        .sm\:flex-col { flex-direction: column; }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .w-1\\/3 { width: 33.333333%; }
        .w-2\\/3 { width: 66.666667%; }
        .md\\:col-span-2 { grid-column: span 2 / span 2; }
        .lg\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .uppercase { text-transform: uppercase; }
        .tracking-wider { letter-spacing: 0.05em; }
        .leading-relaxed { line-height: 1.625; }
        .object-cover { object-fit: cover; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-center { text-align: center; }
        .whitespace-nowrap { white-space: nowrap; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace; }
        .h-96 { height: 24rem; }
        .ring-2 { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        .ring-offset-1 { --tw-ring-offset-width: 2px; }
        .ring-blue-300 { --tw-ring-color: #93c5fd; }
        
        :root {
            --primary-color: #dc2626;
            --primary-dark: #991b1b;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .main-content {
            padding-inline: clamp(1rem, 3vw, 3rem);
        }

        /* Enhanced Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark), #7f1d1d);
        }

        /* Enhanced Flowchart Node Styling */
        .node-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border-left: 5px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .node-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .node-card:hover::before {
            left: 100%;
        }
        
        .node-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .node-card.active {
            border-left-width: 5px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Enhanced Theme Colors */
        .theme-A { 
            border-left-color: #3b82f6; 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        .theme-B { 
            border-left-color: #10b981; 
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        .theme-C { 
            border-left-color: #f59e0b; 
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        .theme-D { 
            border-left-color: #ef4444; 
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        .theme-E { 
            border-left-color: #06b6d4; 
            background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);
        }
        .theme-F { 
            border-left-color: #8b5cf6; 
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        }

        .step-content {
            display: none;
            animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .step-content.active {
            display: block;
        }

        @keyframes slideInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* Enhanced Input Styling */
        .input-group {
            margin-bottom: 1.5rem;
        }
        
        .input-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .input-group input, 
        .input-group textarea, 
        .input-group select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            outline: none;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            line-height: 1.6;
            background: white;
        }
        
        .input-group input:focus, 
        .input-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
            transform: translateY(-1px);
        }

        .field-stack {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .field-stack textarea {
            flex: 1;
        }

        .structured-textarea {
            min-height: 220px;
            background: #f8fafc;
            border-color: #cbd5f5;
            font-family: 'Sarabun', 'Inter', sans-serif;
            white-space: pre-line;
        }

        .structured-textarea.short {
            min-height: 140px;
        }

        .structured-textarea::placeholder {
            color: #94a3b8;
        }

        .responsive-grid-wide,
        .blueprint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            width: 100%;
            align-items: stretch;
        }

        .responsive-grid-medium {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            width: 100%;
            align-items: stretch;
        }

        .blueprint-pair-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 1.5rem;
            width: 100%;
            align-items: stretch;
        }

        .responsive-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
            width: 100%;
            align-items: stretch;
        }

        .blueprint-grid textarea {
            min-height: 260px;
        }

        .full-span {
            grid-column: 1 / -1;
        }

        /* Enhanced AI Button Styling */
        .btn-ai {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
            font-weight: 600;
        }
        
        .btn-ai::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-ai:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 38, 38, 0.3);
        }
        
        .btn-ai:active {
            transform: translateY(0);
        }

        .btn-ai.is-loading {
            cursor: wait;
            opacity: 0.85;
        }
        
        .btn-ai-light {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: var(--primary-color);
            border: 2px solid #fecaca;
            transition: all 0.3s ease;
        }
        
        .btn-ai-light:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border-color: #f87171;
            transform: translateY(-1px);
        }
        
        .btn-ai-field {
            font-size: 0.75rem;
            color: var(--primary-color);
            background: linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%);
            border: 1px solid #fecaca;
            padding: 6px 12px;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }
        
        .btn-ai-field:hover {
            background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            border-color: #fda4af;
            transform: scale(1.05);
        }

        .btn-ai-field.is-loading {
            cursor: wait;
            opacity: 0.8;
        }

        .loading-text {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
        }

        /* Enhanced Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center; 
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content {
            animation: slideInUp 0.3s ease;
        }

        /* Enhanced Loading Spinner */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        .loading-spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid var(--success-color);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger-color);
        }
        
        .toast.info {
            border-left: 4px solid var(--secondary-color);
        }

        .sidebar-mobile {
            position: relative;
            height: auto;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar-mobile {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 40;
            }
            
            .sidebar-mobile.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        @media (min-width: 768px) {
            #sidebar {
                position: relative;
                transform: none !important;
                height: auto;
            }

            body.sidebar-collapsed #sidebar {
                display: none;
            }

            body.sidebar-collapsed .main-content {
                margin-left: 0;
            }
        }

        /* Print Styling */
        @media print {
            body { 
                background: white; 
            }
            .main-container {
                background: white;
                box-shadow: none;
            }
            aside, header, .btn-ai, .btn-ai-field, button, .toast { 
                display: none !important; 
            }
            .step-content { 
                display: block !important; 
                opacity: 1 !important; 
            }
            .step-content > div { 
                page-break-inside: avoid; 
                margin-bottom: 2rem; 
                border: none !important; 
                box-shadow: none !important; 
            }
            textarea { 
                border: none; 
                resize: none; 
                overflow: visible; 
                height: auto; 
                font-family: 'Sarabun', serif; 
            }
            input { 
                border: none; 
            }
            #final-summary-preview { 
                display: block !important; 
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .main-container {
                background: rgba(31, 41, 55, 0.95);
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus visible for better accessibility */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="main-container min-h-screen flex flex-col">
        
        <!-- Enhanced Header -->
        <header class="bg-white border-b border-gray-200 shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="h-16 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <!-- Mobile Menu Button -->
                        <button 
                            onclick="toggleMobileSidebar()" 
                            class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
                        >
                            <i class="fas fa-bars text-gray-600"></i>
                        </button>
                        
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded-xl shadow-lg transform hover:scale-105 transition-transform overflow-hidden">
                                <img src="https://i.postimg.cc/dDfBQVWf/wirun_facbook.png" alt="Wirun Logo" class="w-10 h-10 object-cover rounded-lg">
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                                    EA Flow Builder
                                    <span class="text-xs px-2.5 py-1 rounded-full bg-gradient-to-r from-red-100 to-orange-100 text-red-700 border border-red-200 font-semibold">
                                        <i class="fas fa-robot mr-1"></i>OpenAI GPT-5.2 mini
                                    </span>
                                </h1>
                                <p class="text-xs text-gray-500">Enterprise Architecture Workflow Solution</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <!-- Desktop Sidebar Toggle -->
                        <button 
                            id="sidebar-toggle-btn"
                            onclick="toggleSidebarCollapse()"
                            class="hidden md:flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all text-sm font-medium"
                            title="แสดงหรือซ่อนเมนูด้านซ้าย"
                        >
                            <i id="sidebar-toggle-icon" class="fas fa-chevron-left"></i>
                            <span id="sidebar-toggle-text">Hide Menu</span>
                        </button>
                        
                        <!-- User Info -->
                        <div id="user-info" class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium bg-gray-100">
                            <i class="fas fa-user text-gray-600"></i>
                            <span id="user-name" class="text-gray-700">Guest</span>
                        </div>
                        
                        <!-- Action Buttons -->
                        <button 
                            onclick="exportToTxt()" 
                            class="hidden sm:flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all text-sm font-medium"
                            title="Download Text File"
                        >
                            <i class="fas fa-file-lines"></i>
                            <span class="hidden lg:inline">Save TXT</span>
                        </button>
                        
                        <button 
                            onclick="window.print()" 
                            class="hidden sm:flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all text-sm font-medium"
                            title="Print or Save as PDF"
                        >
                            <i class="fas fa-print"></i>
                            <span class="hidden lg:inline">Print/PDF</span>
                        </button>
                        
                        <div class="h-6 w-px bg-gray-300 mx-1"></div>
                        
                        <button 
                            onclick="logout()" 
                            class="p-2.5 rounded-full hover:bg-gray-100 transition-all group"
                            title="ออกจากระบบ"
                        >
                            <i class="fas fa-sign-out-alt text-lg text-gray-500 group-hover:text-gray-700"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="h-1 bg-gray-100">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-500" style="width: 0%"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex flex-1 overflow-hidden">
            
            <!-- Enhanced Sidebar Navigation -->
            <aside id="sidebar" class="sidebar-mobile md:translate-x-0 w-80 bg-white border-r border-gray-200 flex-none overflow-y-auto z-40">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Architecture Phases</h2>
                        <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">
                            <span id="current-phase">0</span>/6
                        </span>
                    </div>
                    
                    <div class="space-y-3 relative">
                        <div class="absolute left-6 top-6 bottom-6 w-0.5 bg-gradient-to-b from-blue-200 via-purple-200 to-pink-200 -z-10"></div>
                        
                        <!-- Enhanced Navigation Items -->
                        <div 
                            onclick="switchStep('A')" 
                            id="nav-A" 
                            class="node-card theme-A p-4 rounded-xl flex items-center gap-4 relative z-10 group"
                        >
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                1
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-gray-800">Context Analysis</h3>
                                <p class="text-xs text-gray-500 mt-1">SWOT & Strategic Context</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        
                        <div 
                            onclick="switchStep('B')" 
                            id="nav-B" 
                            class="node-card theme-B p-4 rounded-xl flex items-center gap-4 relative z-10 group"
                        >
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-green-600 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                2
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-gray-800">Direction (DM)</h3>
                                <p class="text-xs text-gray-500 mt-1">Goals & Principles</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        
                        <div 
                            onclick="switchStep('C')" 
                            id="nav-C" 
                            class="node-card theme-C p-4 rounded-xl flex items-center gap-4 relative z-10 group"
                        >
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-500 to-yellow-600 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                3
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-gray-800">Blueprint (BM)</h3>
                                <p class="text-xs text-gray-500 mt-1">Business & Tech Architecture</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        
                        <div 
                            onclick="switchStep('D')" 
                            id="nav-D" 
                            class="node-card theme-D p-4 rounded-xl flex items-center gap-4 relative z-10 group"
                        >
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-red-600 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                4
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-gray-800">Roadmap (RM)</h3>
                                <p class="text-xs text-gray-500 mt-1">Timeline & KPIs</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        
                        <div 
                            onclick="switchStep('E')" 
                            id="nav-E" 
                            class="node-card theme-E p-4 rounded-xl flex items-center gap-4 relative z-10 group"
                        >
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-cyan-600 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                5
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-gray-800">Cybersecurity</h3>
                                <p class="text-xs text-gray-500 mt-1">Security & Governance</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        
                        <div 
                            onclick="switchStep('F')" 
                            id="nav-F" 
                            class="node-card theme-F p-4 rounded-xl flex items-center gap-4 relative z-10 group"
                        >
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 text-white flex items-center justify-center text-sm font-bold shadow-lg group-hover:scale-110 transition-transform">
                                6
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-gray-800">Output & Monitor</h3>
                                <p class="text-xs text-gray-500 mt-1">Final Report</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mt-8 p-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl border border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-bolt mr-2"></i>Quick Actions
                        </h3>
                        <div class="space-y-2">
                            <button 
                                onclick="clearAllData()" 
                                class="w-full text-left px-3 py-2 text-sm text-gray-600 hover:bg-white hover:text-gray-800 rounded-lg transition-all"
                            >
                                <i class="fas fa-trash-alt mr-2"></i>Clear All Data
                            </button>
                            <button 
                                onclick="loadSampleData()" 
                                class="w-full text-left px-3 py-2 text-sm text-gray-600 hover:bg-white hover:text-gray-800 rounded-lg transition-all"
                            >
                                <i class="fas fa-database mr-2"></i>Load Sample Data
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Workspace -->
            <main class="flex-1 bg-gradient-to-br from-gray-50 to-gray-100 overflow-y-auto main-content">
                
                <!-- Enhanced Welcome Screen -->
                <div id="content-welcome" class="step-content active p-8 pt-12">
                    <div class="text-center">
                        <div class="inline-block p-8 rounded-3xl bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 mb-8 relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-red-100 to-orange-100 opacity-50"></div>
                            <i class="fas fa-network-wired text-7xl text-red-600 relative z-10"></i>
                        </div>
                        
                        <h2 class="text-4xl font-bold text-gray-900 mb-6 bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">
                            ยินดีต้อนรับสู่ EA Flow Builder
                        </h2>
                        
                        <p class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto leading-relaxed">
                            เครื่องมือช่วยสร้างสถาปัตยกรรมองค์กรอัจฉริยะ ผสานพลัง <strong class="text-red-600">OpenAI GPT-5.2 mini</strong> 
                            ช่วยวิเคราะห์บริบท ร่างวิสัยทัศน์ และออกแบบโครงสร้างแบบ End-to-End
                        </p>
                        
                        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mb-8">
                            <button 
                                onclick="switchStep('A')" 
                                class="bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-4 rounded-xl font-semibold shadow-xl hover:shadow-2xl transition-all transform hover:scale-105 flex items-center gap-3"
                            >
                                <i class="fas fa-rocket"></i>
                                เริ่มสร้าง Architecture
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        
                        <!-- Feature Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                            <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                                    <i class="fas fa-brain text-blue-600 text-xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-2">AI-Powered</h3>
                                <p class="text-sm text-gray-600">ใช้ OpenAI GPT-5.2 mini ช่วยวิเคราะห์และสร้างเนื้อหาอัตโนมัติ</p>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                                    <i class="fas fa-shield-alt text-green-600 text-xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-2">Secure</h3>
                                <p class="text-sm text-gray-600">ระบบ Authentication ปลอดภัย ปกป้องข้อมูลผู้ใช้</p>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                                    <i class="fas fa-cloud-download-alt text-purple-600 text-xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-2">Export Ready</h3>
                                <p class="text-sm text-gray-600">ส่งออกเป็น TXT, PDF พร้อมพิมพ์ได้ทันที</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step A: Context Analysis -->
                <div id="content-A" class="step-content p-8" hidden>
                    <div class="flex items-center justify-between mb-8 border-b pb-6">
                        <div>
                            <span class="text-blue-600 font-bold uppercase tracking-wide text-xs">Phase 1</span>
                            <h2 class="text-3xl font-bold text-gray-800">การวิเคราะห์บริบท (Context Analysis)</h2>
                        </div>
                    </div>

                    <!-- Enhanced Org Input -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 mb-6">
                        <div class="responsive-grid-medium">
                            <div class="input-group">
                                <label class="text-xs font-bold text-gray-500 uppercase">ประเภทองค์กร / ธุรกิจ</label>
                                <input type="text" id="ai-input-org-type" class="w-full text-sm border rounded-lg p-3 mt-1" placeholder="เช่น ร้านยาชุมชน, บริษัท Logistics">
                            </div>
                            <div class="input-group">
                                <label class="text-xs font-bold text-gray-500 uppercase">คำอธิบายสังเขป (Short Description)</label>
                                <textarea id="ai-input-org-desc" class="w-full text-sm border rounded-lg p-3 mt-1" rows="2" placeholder="เช่น เน้นบริการผู้ป่วยเรื้อรัง ต้องการนำ RPA มาใช้ลดงานเอกสาร..."></textarea>
                            </div>
                        </div>
                        <div class="flex justify-end mt-4">
                                <button onclick="generateSWOT()" id="btn-swot" class="btn-ai text-sm px-6 py-3 rounded-lg shadow-sm flex items-center whitespace-nowrap">
                                    <span id="btn-swot-icon"><i class="fas fa-wand-magic-sparkles mr-2"></i></span>
                                    <span id="btn-swot-text">Generate Full SWOT Analysis</span>
                                </button>
                        </div>
                        <div class="mt-4 rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-xs text-amber-800 space-y-1">
                                <p>⚠️ OpenAI GPT-5.2 mini จำกัดปริมาณคำสั่งตามโควต้าบัญชี – กรุณาเว้นช่วง 2–3 วินาทีระหว่างการกดปุ่ม Auto</p>
                                <p>⚠️ หากขึ้น “OpenAI API error” อาจเกิดจากกดถี่หรือข้อความยาวเกิน ให้รอสักครู่แล้วลองใหม่ หรือปรับลดเนื้อหาที่ไม่จำเป็น</p>
                                <p>⚠️ ถ้าไม่ได้ใช้งานนานหรือลบ cookie ระบบจะให้ login ใหม่เพื่อความปลอดภัยก่อนใช้ AI</p>
                        </div>
                    </div>

                    <div class="responsive-grid-medium">
                        <!-- Internal -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-lg mb-4 text-blue-800 border-b pb-2">Internal Factors (ภายใน)</h3>
                            <div class="space-y-4">
                                <div class="input-group">
                                    <label>
                                        Strengths (จุดแข็ง)
                                        <button onclick="generateSingleField('input-strengths', 'Strengths (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-strengths" rows="4" placeholder="เช่น ทีมงานมีความเชี่ยวชาญ..."></textarea>
                                </div>
                                <div class="input-group">
                                    <label>
                                        Weaknesses (จุดอ่อน)
                                        <button onclick="generateSingleField('input-weaknesses', 'Weaknesses (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-weaknesses" rows="4" placeholder="เช่น ขาดแคลนบุคลากรด้าน IT..."></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- External -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                             <h3 class="font-bold text-lg mb-4 text-blue-800 border-b pb-2">External Factors (ภายนอก)</h3>
                             <div class="space-y-4">
                                <div class="input-group">
                                    <label>
                                        Opportunities (โอกาส)
                                        <button onclick="generateSingleField('input-opportunities', 'Opportunities (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-opportunities" rows="4" placeholder="เช่น นโยบาย Telemedicine..."></textarea>
                                </div>
                                 <div class="input-group">
                                    <label>
                                        Threats (อุปสรรค)
                                        <button onclick="generateSingleField('input-threats', 'Threats (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-threats" rows="4" placeholder="เช่น กฎระเบียบที่เข้มงวด..."></textarea>
                                </div>
                             </div>
                        </div>
                        <!-- Context -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 full-span">
                            <h3 class="font-bold text-lg mb-4 text-blue-800 border-b pb-2">Strategic Context</h3>
                            <div class="responsive-grid-medium">
                                <div class="input-group">
                                    <label>
                                        Constraints (ข้อจำกัดหลัก)
                                        <button onclick="generateSingleField('input-constraints', 'Strategic Constraints')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-constraints" rows="3" placeholder="งบประมาณ, กฎหมาย PDPA..."></textarea>
                                </div>
                                <div class="input-group">
                                    <label>
                                        Vision & Mission
                                        <button onclick="generateSingleField('input-vision', 'Vision and Mission statement')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-vision" rows="3" placeholder="ระบุวิสัยทัศน์พันธกิจ..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Next Button -->
                    <div class="mt-8 flex justify-end">
                        <button onclick="switchStep('B')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium shadow-md flex items-center">
                            Next: Direction Management (DM) <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step B: Direction Management -->
                <div id="content-B" class="step-content p-8" hidden>
                    <div class="flex items-center justify-between mb-8 border-b pb-6">
                        <div>
                            <span class="text-green-600 font-bold uppercase tracking-wide text-xs">Phase 2</span>
                            <h2 class="text-3xl font-bold text-gray-800">Direction Management (DM)</h2>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-green-100 mb-6">
                        <h3 class="font-bold text-lg mb-4">กำหนดกรอบคิดเชิงยุทธศาสตร์</h3>
                        <p class="text-xs text-gray-500 mb-4">* AI จะนำข้อมูล Context จาก Phase 1 มาช่วยคิดในส่วนนี้</p>
                        <div class="responsive-grid-medium">
                            <div class="input-group">
                                <label>
                                    Global Trends & Drivers
                                    <button onclick="generateSingleField('input-trends', 'Global Trends')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-trends" rows="3" placeholder="AI in Healthcare, Telepharmacy..."></textarea>
                            </div>
                            <div class="input-group">
                                <label>
                                    Stakeholder Expectations
                                    <button onclick="generateSingleField('input-stakeholders', 'Stakeholder Expectations')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-stakeholders" rows="3" placeholder="ลูกค้าต้องการความรวดเร็ว..."></textarea>
                            </div>
                            <div class="input-group full-span">
                                <label>
                                    Strategic Intent / Goals
                                    <button onclick="generateSingleField('input-goals', 'Strategic Intent / Goals')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-goals" rows="4" placeholder="เป้าหมายเชิงกลยุทธ์..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                        <div class="input-group">
                             <label class="text-green-900">
                                <span class="flex items-center gap-2"><i class="fas fa-gavel"></i> Design Principles & Enablers</span>
                                <button onclick="generateSingleField('input-principles', 'IT Design Principles')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                             </label>
                             <textarea id="input-principles" rows="4" class="bg-white" placeholder="- Mobile First Design&#10;- Zero Trust Security..."></textarea>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between">
                        <button onclick="switchStep('A')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                        <button onclick="switchStep('C')" class="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600 transition font-medium shadow-md flex items-center">
                            Next: Blueprint Management (BM) <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step C: Blueprint Management -->
                <div id="content-C" class="step-content p-8" hidden>
                    <div class="flex items-center justify-between mb-8 border-b pb-6">
                        <div>
                            <span class="text-yellow-600 font-bold uppercase tracking-wide text-xs">Phase 3</span>
                            <h2 class="text-3xl font-bold text-gray-800">Blueprint Management (BM)</h2>
                        </div>
                        <button onclick="generateBlueprint()" id="btn-blueprint" class="btn-ai text-xs px-4 py-2 rounded-lg shadow-sm flex items-center">
                            <span id="btn-blueprint-icon"><i class="fas fa-wand-magic-sparkles mr-1"></i></span>
                            <span id="btn-blueprint-text">Auto Blueprint (Bullet Points)</span>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <!-- Business Arch -->
                        <div class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 shadow-sm">
                            <h4 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
                                <i class="fas fa-briefcase text-yellow-500"></i> 1. Business Architecture
                            </h4>
                            <div class="blueprint-grid">
                                <div class="input-group field-stack">
                                    <label class="text-sm">Front Office <button onclick="generateSingleField('input-biz-front', 'Front Office Capabilities (Bullet points)')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                    <textarea id="input-biz-front" class="structured-textarea" rows="6" placeholder="- Channel A&#10;- CRM System"></textarea>
                                </div>
                                <div class="input-group field-stack">
                                    <label class="text-sm">Core Operations <button onclick="generateSingleField('input-biz-core', 'Core Operations (Bullet points)')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                    <textarea id="input-biz-core" class="structured-textarea" rows="6" placeholder="- Order Mgmt&#10;- Production"></textarea>
                                </div>
                                <div class="input-group field-stack">
                                    <label class="text-sm">Back Office <button onclick="generateSingleField('input-biz-back', 'Back Office Capabilities (Bullet points)')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                    <textarea id="input-biz-back" class="structured-textarea" rows="6" placeholder="- HR System&#10;- Accounting"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Data & Tech -->
                        <div class="blueprint-pair-grid">
                            <div class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 shadow-sm">
                                <div class="input-group field-stack">
                                    <label>
                                        <span class="flex items-center gap-2"><i class="fas fa-database text-yellow-500"></i> 2. Data Architecture</span>
                                        <button onclick="generateSingleField('input-data-arch', 'Data Architecture')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                     </label>
                                    <textarea id="input-data-arch" class="structured-textarea short" rows="4" placeholder="Master Data Entities..."></textarea>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 shadow-sm">
                                <div class="input-group field-stack">
                                    <label>
                                        <span class="flex items-center gap-2"><i class="fas fa-server text-yellow-500"></i> 3. Technology Architecture</span>
                                        <button onclick="generateSingleField('input-tech-arch', 'Technology Architecture')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                     </label>
                                    <textarea id="input-tech-arch" class="structured-textarea short" rows="4" placeholder="Platforms, Cloud..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between">
                        <button onclick="switchStep('B')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                        <button onclick="switchStep('D')" class="bg-rose-500 text-white px-6 py-3 rounded-lg hover:bg-rose-600 transition font-medium shadow-md flex items-center">
                            Next: Roadmap Management (RM) <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step D: Roadmap Management -->
                <div id="content-D" class="step-content p-8" hidden>
                    <div class="flex items-center justify-between mb-8 border-b pb-6">
                        <div>
                            <span class="text-rose-600 font-bold uppercase tracking-wide text-xs">Phase 4</span>
                            <h2 class="text-3xl font-bold text-gray-800">Roadmap Management (RM)</h2>
                        </div>
                        <button onclick="generateRoadmap()" id="btn-roadmap" class="btn-ai text-xs px-4 py-2 rounded-lg shadow-sm flex items-center">
                             <span id="btn-roadmap-icon"><i class="fas fa-wand-magic-sparkles mr-1"></i></span>
                             <span id="btn-roadmap-text">Auto Roadmap</span>
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100 mb-6">
                        <h3 class="font-bold text-lg mb-4 text-rose-800">Transition Architecture (Timeline)</h3>
                        <div class="space-y-4">
                            <div class="input-group pl-4 border-l-4 border-rose-200">
                                <label>Short Term (Quick Wins) <button onclick="generateSingleField('input-short-term', 'Short Term Roadmap')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                <textarea id="input-short-term" rows="3" class="bg-gray-50" placeholder="โครงการระยะสั้น..."></textarea>
                            </div>
                            <div class="input-group pl-4 border-l-4 border-rose-300">
                                <label>Medium Term (Expansion) <button onclick="generateSingleField('input-medium-term', 'Medium Term Roadmap')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                <textarea id="input-medium-term" rows="3" class="bg-gray-50" placeholder="โครงการระยะกลาง..."></textarea>
                            </div>
                            <div class="input-group pl-4 border-l-4 border-rose-400">
                                <label>Long Term (Transformation) <button onclick="generateSingleField('input-long-term', 'Long Term Roadmap')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                <textarea id="input-long-term" rows="3" class="bg-gray-50" placeholder="โครงการระยะยาว..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100">
                        <h3 class="font-bold text-lg mb-4">Balanced Scorecard KPIs</h3>
                        <div class="responsive-grid-medium">
                            <div class="input-group">
                                <label class="text-sm font-bold text-yellow-700">Finance <button onclick="generateSingleField('input-bsc-finance', 'Financial KPIs')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                <textarea id="input-bsc-finance" rows="2" placeholder="ROI, Cost..."></textarea>
                            </div>
                            <div class="input-group">
                                <label class="text-sm font-bold text-blue-700">Customer <button onclick="generateSingleField('input-bsc-customer', 'Customer KPIs')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                <textarea id="input-bsc-customer" rows="2" placeholder="Satisfaction..."></textarea>
                            </div>
                            <div class="input-group">
                                <label class="text-sm font-bold text-green-700">Internal Process <button onclick="generateSingleField('input-bsc-process', 'Process KPIs')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                <textarea id="input-bsc-process" rows="2" placeholder="Efficiency..."></textarea>
                            </div>
                            <div class="input-group">
                                <label class="text-sm font-bold text-purple-700">Learning & Growth <button onclick="generateSingleField('input-bsc-learning', 'Learning KPIs')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                <textarea id="input-bsc-learning" rows="2" placeholder="Upskill..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard & Monitoring Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg text-rose-800">Dashboard & Monitoring KPIs</h3>
                            <button onclick="generateDashboard()" id="btn-dashboard" class="btn-ai text-xs px-4 py-2 rounded-lg shadow-sm flex items-center">
                                <span id="btn-dashboard-icon"><i class="fas fa-wand-magic-sparkles mr-1"></i></span>
                                <span id="btn-dashboard-text">Generate Dashboard</span>
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">* สร้าง Dashboard และ KPIs สำหรับการ Monitor ผลงานในแต่ละแผนก</p>
                        
                        <div class="responsive-grid-medium">
                            <!-- Executive Dashboard -->
                            <div class="bg-gradient-to-br from-rose-50 to-pink-50 p-4 rounded-lg border border-rose-200">
                                <h4 class="font-semibold text-rose-800 mb-3 flex items-center gap-2">
                                    <i class="fas fa-chart-line text-rose-600"></i>
                                    Executive Dashboard
                                </h4>
                                <div class="space-y-3">
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-rose-700">Key Performance Indicators <button onclick="generateSingleField('input-exec-kpis', 'Executive Dashboard KPIs')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-exec-kpis" rows="3" placeholder="Revenue Growth, Market Share, Customer Satisfaction..." class="bg-white"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-rose-700">Critical Success Factors <button onclick="generateSingleField('input-exec-csf', 'Executive Critical Success Factors')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-exec-csf" rows="2" placeholder="Innovation, Operational Excellence, Customer Focus..." class="bg-white"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Project Management Dashboard -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                                <h4 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                    <i class="fas fa-tasks text-blue-600"></i>
                                    Project Management Dashboard
                                </h4>
                                <div class="space-y-3">
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-blue-700">Project Metrics <button onclick="generateSingleField('input-project-metrics', 'Project Management Metrics')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-project-metrics" rows="3" placeholder="Timeline Adherence, Budget Variance, Resource Utilization..." class="bg-white"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-blue-700">Milestone Tracking <button onclick="generateSingleField('input-project-milestones', 'Project Milestone Tracking')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-project-milestones" rows="2" placeholder="Phase Completion, Deliverable Status, Risk Mitigation..." class="bg-white"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- IT Operations Dashboard -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                                <h4 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                    <i class="fas fa-server text-green-600"></i>
                                    IT Operations Dashboard
                                </h4>
                                <div class="space-y-3">
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-green-700">System Performance KPIs <button onclick="generateSingleField('input-it-performance', 'IT Performance KPIs')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-it-performance" rows="3" placeholder="Uptime, Response Time, Throughput, Error Rate..." class="bg-white"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-green-700">Infrastructure Health <button onclick="generateSingleField('input-it-health', 'IT Infrastructure Health Metrics')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-it-health" rows="2" placeholder="Server Status, Network Performance, Storage Capacity..." class="bg-white"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Security & Compliance Dashboard -->
                            <div class="bg-gradient-to-br from-purple-50 to-violet-50 p-4 rounded-lg border border-purple-200">
                                <h4 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    <i class="fas fa-shield-alt text-purple-600"></i>
                                    Security & Compliance Dashboard
                                </h4>
                                <div class="space-y-3">
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-purple-700">Security Metrics <button onclick="generateSingleField('input-security-metrics', 'Security Dashboard Metrics')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-security-metrics" rows="3" placeholder="Incident Response Time, Vulnerability Count, Compliance Score..." class="bg-white"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label class="text-sm font-medium text-purple-700">Risk Indicators <button onclick="generateSingleField('input-risk-indicators', 'Security Risk Indicators')" class="btn-ai-field"><i class="fas fa-wand-magic-sparkles"></i></button></label>
                                        <textarea id="input-risk-indicators" rows="2" placeholder="Threat Level, Security Posture, Audit Findings..." class="bg-white"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Integration Notes -->
                        <div class="mt-4 p-3 bg-rose-50 rounded-lg border border-rose-200">
                            <p class="text-sm text-rose-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>หมายเหตุ:</strong> Dashboard เหล่านี้สามารถนำไปติดตั้งในระบบ Monitoring จริง เช่น Power BI, Tableau, หรือ Grafana 
                                เพื่อให้ผู้บริหารสามารถติดตามความคืบหน้าของแผนงาน EA ได้แบบ Real-time
                            </p>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between">
                        <button onclick="switchStep('C')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                        <button onclick="switchStep('E')" class="bg-cyan-500 text-white px-6 py-3 rounded-lg hover:bg-cyan-600 transition font-medium shadow-md flex items-center">
                            Next: Cybersecurity <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step E: Security & Governance -->
                <div id="content-E" class="step-content p-8" hidden>
                    <div class="flex items-center justify-between mb-8 border-b pb-6">
                        <div>
                            <span class="text-cyan-600 font-bold uppercase tracking-wide text-xs">Phase 5</span>
                            <h2 class="text-3xl font-bold text-gray-800">Cybersecurity & Governance Layer</h2>
                        </div>
                        <button onclick="generateSecurity()" id="btn-security" class="btn-ai text-xs px-4 py-2 rounded-lg shadow-sm flex items-center">
                             <span id="btn-security-icon"><i class="fas fa-wand-magic-sparkles mr-1"></i></span>
                             <span id="btn-security-text">Auto Analyze</span>
                        </button>
                    </div>

                    <div class="bg-cyan-50 border border-cyan-200 rounded-xl p-6 mb-6">
                        <p class="text-cyan-800 mb-6 text-sm flex items-center gap-2">
                            <i class="fas fa-info-circle"></i>
                            Cross-cutting Architecture 5 มิติ
                        </p>
                        
                        <div class="responsive-grid-medium">
                            <!-- 5 Security Controls -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100 field-stack">
                                <div class="input-group">
                                    <label class="text-cyan-800">
                                        1. Governance & Policy
                                        <button onclick="generateSingleField('input-gov', 'Security Governance & Policy')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-gov" class="structured-textarea short" placeholder="ระบุผู้รับผิดชอบ..."></textarea>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100 field-stack">
                                <div class="input-group">
                                    <label class="text-cyan-800">
                                        2. Risk Identification
                                        <button onclick="generateSingleField('input-risk', 'Cybersecurity Risk Analysis')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-risk" class="structured-textarea short" placeholder="ความเสี่ยงหลัก..."></textarea>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100 field-stack">
                                <div class="input-group">
                                    <label class="text-cyan-800">
                                        3. Protection Controls
                                        <button onclick="generateSingleField('input-protect', 'Cybersecurity Protection Controls')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-protect" class="structured-textarea short" placeholder="มาตรการป้องกัน..."></textarea>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100 field-stack">
                                <div class="input-group">
                                    <label class="text-cyan-800">
                                        4. Detection Controls
                                        <button onclick="generateSingleField('input-detect', 'Cybersecurity Detection Controls')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-detect" class="structured-textarea short" placeholder="มาตรการตรวจจับ..."></textarea>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100 field-stack full-span">
                                <div class="input-group">
                                    <label class="text-cyan-800">
                                        5. Response & Recovery
                                        <button onclick="generateSingleField('input-respond', 'Cybersecurity Response & Recovery Plan')" class="btn-ai-field" title="Auto-fill"><i class="fas fa-wand-magic-sparkles"></i> AI</button>
                                    </label>
                                    <textarea id="input-respond" class="structured-textarea short" placeholder="แผนกู้คืน..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between">
                        <button onclick="switchStep('D')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                        <button onclick="switchStep('F')" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition font-medium shadow-md flex items-center">
                            Next: Output & Monitor <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                 <!-- Step F: Output & Monitoring -->
                 <div id="content-F" class="step-content p-8" hidden>
                    <div class="flex items-center justify-between mb-8 border-b pb-6">
                        <div>
                            <span class="text-purple-600 font-bold uppercase tracking-wide text-xs">Phase 6</span>
                            <h2 class="text-3xl font-bold text-gray-800">EA Output & Monitoring</h2>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-purple-400 mb-8">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="inline-block p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-file-contract text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Final EA Document Preview</h3>
                                <p class="text-sm text-gray-500">สรุปข้อมูลจากทุกขั้นตอน (Phase 1-5)</p>
                            </div>
                        </div>
                        
                        <!-- SUMMARY PREVIEW AREA -->
                        <div id="final-summary-preview" class="bg-gray-50 p-6 rounded-lg border border-gray-200 text-sm text-gray-700 leading-relaxed mb-6 font-mono whitespace-pre-wrap h-96 overflow-y-auto">
                            <!-- Content will be auto-populated here -->
                        </div>
                        
                        <div class="flex justify-center gap-4 border-t pt-6">
                            <button onclick="exportToTxt()" class="px-6 py-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition flex items-center">
                                <i class="fas fa-file-lines mr-2"></i> Download Text File
                            </button>
                            <button onclick="window.print()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition flex items-center">
                                <i class="fas fa-print mr-2"></i> Print / Save as PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-start">
                        <button onclick="switchStep('E')" class="text-gray-500 hover:text-gray-800">กลับไปแก้ไข</button>
                    </div>
                </div>

            </main>
        </div>

        <!-- Footer with Credit -->
        <footer class="bg-white border-t border-gray-200 py-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-code mr-1"></i>
                        จัดทำโดย เภสัชกรวิรุณ เวชศิริ
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                        Powered by OpenAI GPT-5.2 mini | Enterprise Architecture Workflow Solution
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Enhanced Script -->
    <script>
        let currentStep = 'welcome';
        let currentUser = null;

        const APP_HOSTNAME = window.location.hostname;
        const LOCAL_HOSTS = ['localhost', '127.0.0.1'];
        const isLocalHost = LOCAL_HOSTS.includes(APP_HOSTNAME);
        const isGitHubPages = APP_HOSTNAME.includes('github.io');

        const getApiBaseUrl = () => {
            if (window.EA_CONFIG && typeof window.EA_CONFIG.getApiBaseUrl === 'function') {
                return window.EA_CONFIG.getApiBaseUrl() || '';
            }
            return '';
        };

        const shouldUseLocalAuth = () => {
            if (isLocalHost) {
                return true;
            }
            if (isGitHubPages && !getApiBaseUrl()) {
                return true;
            }
            return false;
        };

        const getApiUrl = (path) => {
            if (window.EA_CONFIG && typeof window.EA_CONFIG.getApiUrl === 'function') {
                return window.EA_CONFIG.getApiUrl(path);
            }
            return path;
        };

        const OPENAI_SYSTEM_PROMPT = `You are an AI assistant specialized in Enterprise Architecture (EA), designed to support strategic planning, system design, and organizational alignment across business, data, application, and technology layers.

You help users analyze complex organizations, clarify business capabilities, map processes, design target architectures, and evaluate trade-offs between people, process, and technology. You can assist with frameworks such as TOGAF, Zachman, ArchiMate, BMC, or custom EA models, while adapting explanations to the user's level of technical understanding.

You provide clear, structured, and honest guidance without unnecessary affirmations or filler phrases such as “Certainly!”, “Of course!”, or similar expressions. You respond directly and thoughtfully to each request, focusing on reasoning, structure, and practical applicability rather than buzzwords.

You always respond in the language used by the user.
Your writing style is professional, clear, and conversational, showing genuine interest in understanding the organizational context, constraints, and goals. You express appropriate empathy when discussing real-world challenges such as legacy systems, organizational resistance, resource limitations, or regulatory constraints.

Your primary goal is to help the user:
- Understand the current-state architecture
- Design a future-state (target) architecture
- Define transition roadmaps
- Make informed architectural decisions that align strategy, operations, and technology.`;

        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            checkAuthentication();
            updateProgressBar();
        });

        // Authentication Functions
        async function checkAuthentication() {
            const token = localStorage.getItem('ea_session');
            const userInfo = localStorage.getItem('ea_user');
            
            if (token && userInfo) {
                try {
                    if (shouldUseLocalAuth()) {
                        const user = JSON.parse(userInfo);
                        if (user && user.id) {
                            currentUser = user;
                            updateUserDisplay();
                            return true;
                        }
                    } else {
                        const response = await fetch(getApiUrl('/api/validate'), {
                            headers: {
                                'Authorization': 'Bearer ' + token
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.valid) {
                                currentUser = JSON.parse(userInfo);
                                updateUserDisplay();
                                return true;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Auth validation error:', error);
                }
            }
            
            // Redirect to login if not authenticated
            window.location.href = 'login.html';
            return false;
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-name').textContent = currentUser.name || currentUser.username;
            }
        }

        function logout() {
            localStorage.removeItem('ea_session');
            localStorage.removeItem('ea_user');
            window.location.href = 'login.html';
        }

        // Safe value getter
        const getVal = (id) => document.getElementById(id)?.value || "";

        // Context Collector: Gathers all filled data to feed AI memory
        function collectContext() {
            return `
            Context Data (User Input So Far):
            - Org Type: ${getVal('ai-input-org-type')}
            - Org Description: ${getVal('ai-input-org-desc')}
            - SWOT Strengths: ${getVal('input-strengths')}
            - SWOT Weaknesses: ${getVal('input-weaknesses')}
            - Vision/Mission: ${getVal('input-vision')}
            - Strategic Goals: ${getVal('input-goals')}
            - Trends: ${getVal('input-trends')}
            - Stakeholders: ${getVal('input-stakeholders')}
            `;
        }

        // Normalize AI JSON outputs for textareas
        function formatStructuredValue(value, indent = 0) {
            if (value == null) return '';
            const prefix = ' '.repeat(indent);
            if (typeof value === 'string') return value.trim();
            if (typeof value === 'number' || typeof value === 'boolean') return String(value);
            if (Array.isArray(value)) {
                return value.map(item => {
                    const formatted = formatStructuredValue(item, indent + 2);
                    return formatted ? `${prefix}- ${formatted}` : '';
                }).filter(Boolean).join('\n');
            }
            if (typeof value === 'object') {
                return Object.entries(value).map(([key, val]) => {
                    const formatted = formatStructuredValue(val, indent + 2);
                    if (!formatted) return `${prefix}${key}`;
                    if (formatted.includes('\n')) {
                        return `${prefix}${key}:\n${formatted}`;
                    }
                    return `${prefix}${key}: ${formatted}`;
                }).join('\n');
            }
            return '';
        }

        function switchStep(stepId) {
            currentStep = stepId;
            
            document.querySelectorAll('.node-card').forEach(item => item.classList.remove('active', 'ring-2', 'ring-offset-1', 'ring-blue-300'));
            const navItem = document.getElementById(`nav-${stepId}`);
            if (navItem) {
                navItem.classList.add('active', 'ring-2', 'ring-offset-1', 'ring-blue-300');
            }
            
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
                content.setAttribute('hidden', '');
            });
            
            const targetContent = document.getElementById(`content-${stepId}`);
            if (targetContent) {
                targetContent.classList.add('active');
                targetContent.removeAttribute('hidden');
            }
            
            updateProgressBar();
            document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });

            if (stepId === 'F') {
                renderSummary();
            }
            
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        function updateProgressBar() {
            const steps = ['welcome', 'A', 'B', 'C', 'D', 'E', 'F'];
            const currentIndex = steps.indexOf(currentStep);
            const progress = ((currentIndex + 1) / steps.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            
            // Update phase counter
            if (currentStep !== 'welcome') {
                const phaseNum = steps.indexOf(currentStep);
                document.getElementById('current-phase').textContent = phaseNum;
            } else {
                document.getElementById('current-phase').textContent = '0';
            }
        }

        function renderSummary() {
            let content = "=== Enterprise Architecture Report ===\n\n";
            content += `[Organization]: ${getVal('ai-input-org-type')} - ${getVal('ai-input-org-desc')}\n\n`;
            
            content += "--- PHASE 1: CONTEXT ---\n";
            content += `Strengths:\n${getVal('input-strengths')}\n\n`;
            content += `Weaknesses:\n${getVal('input-weaknesses')}\n\n`;
            content += `Opportunities:\n${getVal('input-opportunities')}\n\n`;
            content += `Threats:\n${getVal('input-threats')}\n\n`;
            content += `Constraints: ${getVal('input-constraints')}\n`;
            content += `Vision: ${getVal('input-vision')}\n\n`;

            content += "--- PHASE 2: DIRECTION ---\n";
            content += `Trends: ${getVal('input-trends')}\n`;
            content += `Stakeholders: ${getVal('input-stakeholders')}\n`;
            content += `Goals:\n${getVal('input-goals')}\n`;
            content += `Principles:\n${getVal('input-principles')}\n\n`;

            content += "--- PHASE 3: BLUEPRINT ---\n";
            content += `Front Office:\n${getVal('input-biz-front')}\n\n`;
            content += `Core Ops:\n${getVal('input-biz-core')}\n\n`;
            content += `Back Office:\n${getVal('input-biz-back')}\n\n`;
            content += `Data Arch:\n${getVal('input-data-arch')}\n\n`;
            content += `Tech Arch:\n${getVal('input-tech-arch')}\n\n`;

            content += "--- PHASE 4: ROADMAP ---\n";
            content += `Short Term: ${getVal('input-short-term')}\n`;
            content += `Medium Term: ${getVal('input-medium-term')}\n`;
            content += `Long Term: ${getVal('input-long-term')}\n\n`;
            
            content += "BALANCED SCORECARD KPIS:\n";
            content += `Finance: ${getVal('input-bsc-finance')}\n`;
            content += `Customer: ${getVal('input-bsc-customer')}\n`;
            content += `Internal Process: ${getVal('input-bsc-process')}\n`;
            content += `Learning & Growth: ${getVal('input-bsc-learning')}\n\n`;
            
            content += "DASHBOARD & MONITORING KPIS:\n";
            content += "Executive Dashboard:\n";
            content += `- KPIs: ${getVal('input-exec-kpis')}\n`;
            content += `- Critical Success Factors: ${getVal('input-exec-csf')}\n\n`;
            
            content += "Project Management Dashboard:\n";
            content += `- Project Metrics: ${getVal('input-project-metrics')}\n`;
            content += `- Milestone Tracking: ${getVal('input-project-milestones')}\n\n`;
            
            content += "IT Operations Dashboard:\n";
            content += `- System Performance: ${getVal('input-it-performance')}\n`;
            content += `- Infrastructure Health: ${getVal('input-it-health')}\n\n`;
            
            content += "Security & Compliance Dashboard:\n";
            content += `- Security Metrics: ${getVal('input-security-metrics')}\n`;
            content += `- Risk Indicators: ${getVal('input-risk-indicators')}\n\n`;

            content += "--- PHASE 5: SECURITY ---\n";
            content += `Governance: ${getVal('input-gov')}\n`;
            content += `Risks: ${getVal('input-risk')}\n`;
            content += `Controls: ${getVal('input-protect')}, ${getVal('input-detect')}, ${getVal('input-respond')}\n`;

            document.getElementById('final-summary-preview').textContent = content;
        }

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleSidebarCollapse() {
            const body = document.body;
            const isCollapsed = body.classList.toggle('sidebar-collapsed');
            const toggleText = document.getElementById('sidebar-toggle-text');
            const toggleIcon = document.getElementById('sidebar-toggle-icon');
            
            if (toggleText) {
                toggleText.textContent = isCollapsed ? 'Show Menu' : 'Hide Menu';
            }
            
            if (toggleIcon) {
                toggleIcon.classList.remove('fa-chevron-left', 'fa-chevron-right');
                toggleIcon.classList.add(isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                         type === 'error' ? 'fa-exclamation-circle' : 
                         'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-lg"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Export Functions ---
        function exportToTxt() {
            renderSummary(); // Ensure latest data
            const content = document.getElementById('final-summary-preview').textContent;
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "EA_Report.txt";
            a.click();
            URL.revokeObjectURL(url);
            showToast('Report downloaded successfully!', 'success');
        }

        // --- Data Management ---
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                // Clear all text inputs and textareas
                document.querySelectorAll('input[type="text"], textarea').forEach(element => {
                    element.value = '';
                });
                showToast('All data cleared', 'info');
            }
        }

        function loadSampleData() {
            const sampleData = {
                'ai-input-org-type': 'ร้านยาชุมชน',
                'ai-input-org-desc': 'ร้านยาขนาดเล็กที่ให้บริการผู้ป่วยเรื้อรังและลูกค้าทั่วไป ต้องการปรับปรุงระบบการจัดการคลังสินค้าและบริการลูกค้า',
                'input-strengths': 'ทีมงานมีประสบการณ์สูง มีฐานลูกค้าภักดี ตำแหน่งที่ตั้งสะดวกสบาย',
                'input-weaknesses': 'ระบบคอมพิวเตอร์เก่า ขาดบุคลากรด้าน IT การจัดการคลังสินค้ายังใช้กระดาษ',
                'input-opportunities': 'นโยบาย Telemedicine การเติบโตของตลาดสุขภาพ เทคโนโลยีใหม่ๆ ในการดูแลผู้ป่วย',
                'input-threats': 'การแข่งขันจากห้างสรรพสินค้า กฎระเบียบที่เข้มงวด การเปลี่ยนแปลงพฤติกรรมลูกค้า',
                'input-constraints': 'งบประมาณจำกัด กฎหมาย PDPA จำเป็นต้องคงระบบเก่าไปพลาง',
                'input-vision': 'เป็นร้านยาชั้นนำในพื้นที่ที่ให้บริการครบวงจรด้วยเทคโนโลยีสมัยใหม่',
                'input-goals': '1. ลดเวลารอบ้านลูกค้า 30% 2. เพิ่มประสิทธิภาพการจัดการคลัง 50% 3. พัฒนาระบบบริการออนไลน์',
                'input-trends': 'AI ในการวินิจฉัยโรค Telepharmacy การติดตามสุขภาพผ่านแอปพลิเคชัน',
                'input-stakeholders': 'ลูกค้าต้องการความรวดเร็ว แพทย์ต้องการข้อมูลที่แม่นยำ พนักงานต้องการเครื่องมือที่ง่ายต่อการใช้งาน',
                'input-principles': '- Mobile First Design\n- Zero Trust Security\n- Cloud Native Architecture\n- API-First Development'
            };
            
            Object.keys(sampleData).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = sampleData[id];
            });
            
            showToast('Sample data loaded successfully!', 'success');
        }

        function extractTextFromOpenAIRaw(raw) {
            if (!raw || !Array.isArray(raw.output)) return '';
            return raw.output
                .filter(part => part.type === 'message')
                .map(part => {
                    const chunks = Array.isArray(part.content)
                        ? part.content
                            .filter(chunk => chunk.type === 'output_text' || chunk.type === 'summary_text')
                            .map(chunk => chunk.text)
                        : [];
                    return chunks.join('\n').trim();
                })
                .join('\n\n')
                .trim();
        }

        function sanitizeJsonResponse(raw) {
            if (!raw || typeof raw !== 'string') return '';
            
            let cleaned = raw.trim();
            
            // Remove markdown code blocks
            cleaned = cleaned.replace(/```json\s*|```\s*/gi, '').trim();
            
            // Find JSON object boundaries
            const firstBrace = cleaned.indexOf('{');
            const lastBrace = cleaned.lastIndexOf('}');
            
            if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                cleaned = cleaned.slice(firstBrace, lastBrace + 1);
            }
            
            // Fix common JSON issues
            cleaned = cleaned
                .replace(/,\s*}/g, '}') // Remove trailing commas
                .replace(/,\s*]/g, ']') // Remove trailing commas in arrays
                .replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*):/g, '$1"$2":') // Quote unquoted keys
                .replace(/:\s*'([^']*)'/g, ':"$1"') // Convert single quotes to double quotes
                .replace(/:\s*([^",\[\]{}\s][^",\[\]{}\s]*)/g, ':"$1"'); // Quote unquoted values
            
            return cleaned;
        }

        function tryParseJson(raw) {
            try {
                const cleaned = sanitizeJsonResponse(raw);
                if (!cleaned) return null;
                
                // Additional validation
                if (cleaned.startsWith('{') && cleaned.endsWith('}')) {
                    return JSON.parse(cleaned);
                }
                return null;
            } catch (error) {
                console.warn('Unable to parse JSON:', error.message, 'Raw:', raw.substring(0, 200) + '...');
                return null;
            }
        }

        function parseJsonOrNotify(raw, label) {
            try {
                const cleaned = sanitizeJsonResponse(raw);
                if (!cleaned) {
                    throw new Error('Empty or invalid JSON response');
                }
                
                // Additional validation
                if (!cleaned.startsWith('{') || !cleaned.endsWith('}')) {
                    throw new Error('Response is not a valid JSON object');
                }
                
                return JSON.parse(cleaned);
            } catch (error) {
                console.error(`JSON parse failed for ${label}:`, error.message, 'Raw:', raw.substring(0, 500) + '...');
                
                // Try to fix common JSON issues and retry
                try {
                    const cleaned = sanitizeJsonResponse(raw);
                    const fixed = fixTruncatedJson(cleaned);
                    if (fixed) {
                        console.log(`Attempting to parse fixed JSON for ${label}`);
                        return JSON.parse(fixed);
                    }
                } catch (fixError) {
                    console.error('Fixed JSON also failed:', fixError.message);
                }
                
                showToast(`Error parsing ${label} data: ${error.message}`, 'error');
                return null;
            }
        }

        function fixTruncatedJson(jsonStr) {
            if (!jsonStr || typeof jsonStr !== 'string') return null;
            
            let fixed = jsonStr.trim();
            
            // Handle truncated arrays - close them properly
            const openArrays = (fixed.match(/\[/g) || []).length;
            const closeArrays = (fixed.match(/\]/g) || []).length;
            const missingBrackets = openArrays - closeArrays;
            
            if (missingBrackets > 0) {
                fixed += ']'.repeat(missingBrackets);
            }
            
            // Handle truncated objects - close them properly
            const openBraces = (fixed.match(/{/g) || []).length;
            const closeBraces = (fixed.match(/}/g) || []).length;
            const missingBraces = openBraces - closeBraces;
            
            if (missingBraces > 0) {
                fixed += '}'.repeat(missingBraces);
            }
            
            // Remove trailing commas before closing brackets/braces
            fixed = fixed.replace(/,\s*([}\]])/g, '$1');
            
            // Fix incomplete string values
            fixed = fixed.replace(/("[^"]*?)$/gm, '$1"');
            
            // Validate if it looks like valid JSON now
            try {
                JSON.parse(fixed);
                return fixed;
            } catch (e) {
                // If still invalid, try a more aggressive fix
                const aggressiveFix = fixed.replace(/"[^"]*?$/gm, '""').replace(/:\s*([^",\[\]{}\s][^",\[\]{}\s]*)$/gm, ':"$1"');
                try {
                    JSON.parse(aggressiveFix);
                    return aggressiveFix;
                } catch (e2) {
                    return null;
                }
            }
        }

        // --- OpenAI API (Server-side) ---
        async function callOpenAI(prompt, buttonId, textId, originalText, isIcon = false, options = {}) {
            const token = localStorage.getItem('ea_session');
            if (!token) {
                showToast('กรุณาเข้าสู่ระบบใหม่', 'error');
                logout();
                return null;
            }

            const button = buttonId ? document.getElementById(buttonId) : null;
            const textSpan = textId ? document.getElementById(textId) : null;
            const iconSpan = buttonId ? document.getElementById(buttonId + '-icon') : null;
            const btnElement = (!buttonId && typeof event !== 'undefined') ? event.currentTarget : null;

            let originalContent = "";
            if (button) {
                originalContent = iconSpan.innerHTML;
                if(textSpan) textSpan.innerText = 'กำลังสร้าง...';
                button.disabled = true;
                button.classList.add('is-loading');
                button.setAttribute('aria-busy', 'true');
                iconSpan.innerHTML = '<span class="loading-spinner"></span>';
            } else if (btnElement) {
                originalContent = btnElement.innerHTML;
                btnElement.disabled = true;
                btnElement.classList.add('is-loading');
                btnElement.setAttribute('aria-busy', 'true');
                btnElement.innerHTML = '<span class="loading-spinner-dark"></span><span class="loading-text">กำลังสร้าง...</span>';
            }

            try {
                // For local development, simulate AI response
                if (shouldUseLocalAuth()) {
                    // Simulate API delay
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Generate mock response based on prompt type
                    let mockResponse = "";
                    if (prompt.includes('SWOT')) {
                        mockResponse = JSON.stringify({
                            strengths: "ทีมงานมีความเชี่ยวชาญสูง มีฐานลูกค้าภักดี ตำแหน่งที่ตั้งสะดวกสบาย",
                            weaknesses: "ระบบคอมพิวเตอร์เก่า ขาดบุคลากรด้าน IT การจัดการคลังสินค้ายังใช้กระดาษ",
                            opportunities: "นโยบาย Telemedicine การเติบโตของตลาดสุขภาพ เทคโนโลยีใหม่ๆ ในการดูแลผู้ป่วย",
                            threats: "การแข่งขันจากห้างสรรพสินค้า กฎระเบียบที่เข้มงวด การเปลี่ยนแปลงพฤติกรรมลูกค้า"
                        });
                    } else if (prompt.includes('Blueprint')) {
                        mockResponse = JSON.stringify({
                            biz_front: "- Customer Service System\n- Point of Sale (POS)\n- Customer Relationship Management (CRM)",
                            biz_core: "- Inventory Management\n- Order Processing\n- Quality Control System",
                            biz_back: "- Human Resource System\n- Financial Management\n- Compliance Reporting",
                            data: "- Customer Master Data\n- Product Catalog\n- Transaction Records\n- Analytics Database",
                            tech: "- Cloud Infrastructure (AWS/Azure)\n- Mobile Application\n- Web Portal\n- API Gateway"
                        });
                    } else if (prompt.includes('Roadmap')) {
                        mockResponse = JSON.stringify({
                            short: "1. ปรับปรุงระบบ POS 2. พัฒนา Mobile App 3. ฝึกอบรมพนักงาน",
                            medium: "1. ติดตั้งระบบ CRM 2. พัฒนา E-commerce 3. ปรับปรุง Supply Chain",
                            long: "1. ย้ายระบบไป Cloud 2. พัฒนา AI Analytics 3. ขยายสาขา"
                        });
                    } else if (prompt.includes('Dashboard')) {
                        mockResponse = JSON.stringify({
                            exec_kpis: "Revenue Growth (15% YoY), Customer Satisfaction Score (4.5/5), Market Share Increase (5%)",
                            exec_csf: "Digital Transformation Success, Operational Excellence, Customer Experience Innovation",
                            project_metrics: "Project Completion Rate (95%), Budget Adherence (±5%), Timeline Compliance (90%)",
                            project_milestones: "Phase 1: System Analysis (Q1), Phase 2: Development (Q2-Q3), Phase 3: Deployment (Q4)",
                            it_performance: "System Uptime (99.9%), Response Time (<2s), Throughput (1000 req/sec)",
                            it_health: "Server CPU Usage (<70%), Memory Usage (<80%), Storage Capacity (60% available)",
                            security_metrics: "Security Incidents (0), Vulnerability Patch Time (<24h), Compliance Score (95%)",
                            risk_indicators: "Threat Level (Low), Security Posture (Strong), Audit Findings (Minor)"
                        });
                    } else if (prompt.includes('Security')) {
                        mockResponse = JSON.stringify({
                            gov: "Data Protection Officer รับผิดชอบ, มีนโยบายความปลอดภัยชัดเจน, ปฏิบัติตาม PDPA",
                            risk: "Data Breach, System Downtime, Cyber Attacks, Compliance Violations",
                            protect: "Firewall, Antivirus, Data Encryption, Access Control, Regular Backup",
                            detect: "Security Monitoring, Intrusion Detection, Log Analysis, Security Scanning",
                            respond: "Incident Response Team, Disaster Recovery Plan, Communication Protocol, Forensic Analysis"
                        });
                    } else {
                        // Generic response for single field generation
                        mockResponse = "นี่คือเนื้อหาตัวอย่างที่สร้างโดย AI สำหรับฟิลด์นี้ ในการใช้งานจริงจะเรียกใช้ OpenAI GPT-5.2 mini";
                    }
                    
                    return mockResponse;
                } else {
                    // Production: Call actual API
                    const systemPromptLength = OPENAI_SYSTEM_PROMPT.length;
                    const approxPromptTokens = Math.ceil((systemPromptLength + prompt.length) / 4);
                    const minOutputTokens = approxPromptTokens + 50;
                    const requestedOutputTokens = typeof options.max_output_tokens === 'number'
                        ? options.max_output_tokens
                        : 600;
                    const computedOutputTokens = Math.max(minOutputTokens, requestedOutputTokens);

                    const requestPayload = {
                        messages: [
                             { role: 'system', content: OPENAI_SYSTEM_PROMPT },
                             { role: 'user', content: prompt }
                        ],
                        max_output_tokens: Math.min(1200, computedOutputTokens),
                        text_format: options.text_format || 'text',
                        text_verbosity: options.text_verbosity || (options.expectJson ? 'low' : 'medium'),
                        reasoning_effort: options.reasoning_effort || 'medium',
                        tools: options.tools || [],
                        include: options.include,
                        store: typeof options.store === 'boolean' ? options.store : true
                    };

                    const response = await fetch(getApiUrl('/api/openai'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(requestPayload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'API Request Failed');
                    }

                    const data = await response.json();
                    if (data.success) {
                        const extracted = data.data?.text || extractTextFromOpenAIRaw(data.data?.raw);
                        if (extracted) {
                            return extracted;
                        }
                    }
                    throw new Error("No AI response");
                }
            } catch (error) {
                console.error('OpenAI API error:', error); 
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
                return null;
            } finally {
                if (button) {
                    if(textSpan) textSpan.innerText = originalText;
                    if (iconSpan) iconSpan.innerHTML = originalContent;
                    button.disabled = false;
                    button.classList.remove('is-loading');
                    button.removeAttribute('aria-busy');
                } else if (btnElement) {
                    btnElement.innerHTML = originalContent;
                    btnElement.disabled = false;
                    btnElement.classList.remove('is-loading');
                    btnElement.removeAttribute('aria-busy');
                }
            }
        }

        // Updated Generator Functions with Context
        async function generateSingleField(fieldId, topic) {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Based on context above (especially previous inputs), write concise Thai content for "${topic}".
            If specific info is missing, imply reasonable assumptions for this org type.
            Return ONLY content text, no intro/outro.`;
            
            const res = await callOpenAI(prompt, null, null, null, true);
            if(res) {
                document.getElementById(fieldId).value = res.replace(/"/g, '');
                showToast('Content generated successfully!', 'success');
            }
        }

        async function generateSWOT() {
            const orgType = document.getElementById('ai-input-org-type').value;
            const orgDesc = document.getElementById('ai-input-org-desc').value;
            if(!orgType) { 
                showToast('ระบุองค์กรก่อนครับ', 'error'); 
                return; 
            }

            const prompt = `Analyze SWOT for Organization: "${orgType}". Description: "${orgDesc}".
            IMPORTANT: Return ONLY valid JSON with keys: "strengths", "weaknesses", "opportunities", "threats".`;

            const res = await callOpenAI(prompt, 'btn-swot', 'btn-swot-text', 'Auto SWOT', false, { expectJson: true });
            if(res) {
                const data = parseJsonOrNotify(res, 'SWOT');
                if (!data) return;
                document.getElementById('input-strengths').value = formatStructuredValue(data.strengths);
                document.getElementById('input-weaknesses').value = formatStructuredValue(data.weaknesses);
                document.getElementById('input-opportunities').value = formatStructuredValue(data.opportunities);
                document.getElementById('input-threats').value = formatStructuredValue(data.threats);
                showToast('SWOT Analysis completed!', 'success');
            }
        }

        async function generateBlueprint() {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Draft EA Blueprint.
            Requirements:
            - Business Architecture (Front/Core/Back) must be bullet points list.
            - Tech & Data must align with Goals.
            IMPORTANT: Return ONLY valid JSON with keys: "biz_front", "biz_core", "biz_back", "data", "tech".`;

            const attempt = async (maxTokens) => {
                return callOpenAI(
                    prompt,
                    'btn-blueprint',
                    'btn-blueprint-text',
                    'Auto Blueprint (Bullet Points)',
                    false,
                    { expectJson: true, max_output_tokens: maxTokens }
                );
            };

            let res = await attempt(600);
            if(!res) return;

            let data = tryParseJson(res);
            if (!data) {
                res = await attempt(900);
                if(!res) return;
                data = parseJsonOrNotify(res, 'Blueprint');
                if (!data) return;
            }

            document.getElementById('input-biz-front').value = formatStructuredValue(data.biz_front);
            document.getElementById('input-biz-core').value = formatStructuredValue(data.biz_core);
            document.getElementById('input-biz-back').value = formatStructuredValue(data.biz_back);
            document.getElementById('input-data-arch').value = formatStructuredValue(data.data);
            document.getElementById('input-tech-arch').value = formatStructuredValue(data.tech);
            showToast('Blueprint generated successfully!', 'success');
        }

        async function generateRoadmap() {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Create IT Roadmap based on Blueprint and Goals.
            IMPORTANT: Return ONLY valid JSON with keys: "short", "medium", "long".`;

            const res = await callOpenAI(prompt, 'btn-roadmap', 'btn-roadmap-text', 'Auto Roadmap', false, { expectJson: true });
            if(res) {
                const data = parseJsonOrNotify(res, 'Roadmap');
                if (!data) return;
                document.getElementById('input-short-term').value = formatStructuredValue(data.short);
                document.getElementById('input-medium-term').value = formatStructuredValue(data.medium);
                document.getElementById('input-long-term').value = formatStructuredValue(data.long);
                showToast('Roadmap generated successfully!', 'success');
            }
        }

        async function generateSecurity() {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Analyze Cyber Security based on Tech Architecture.
            IMPORTANT: Return ONLY valid JSON with keys: "gov", "risk", "protect", "detect", "respond".`;

            const res = await callOpenAI(prompt, 'btn-security', 'btn-security-text', 'Auto Analyze', false, { expectJson: true });
            if(res) {
                const data = parseJsonOrNotify(res, 'Security');
                if (!data) return;
                document.getElementById('input-gov').value = formatStructuredValue(data.gov);
                document.getElementById('input-risk').value = formatStructuredValue(data.risk);
                document.getElementById('input-protect').value = formatStructuredValue(data.protect);
                document.getElementById('input-detect').value = formatStructuredValue(data.detect);
                document.getElementById('input-respond').value = formatStructuredValue(data.respond);
                showToast('Security analysis completed!', 'success');
            }
        }

        async function generateDashboard() {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Generate comprehensive Dashboard KPIs for monitoring EA implementation across 4 key areas.
            Requirements:
            - Executive Dashboard: Strategic KPIs and Critical Success Factors for C-level monitoring
            - Project Management Dashboard: Project metrics and milestone tracking for implementation teams
            - IT Operations Dashboard: System performance and infrastructure health metrics for IT teams
            - Security & Compliance Dashboard: Security metrics and risk indicators for compliance teams
            - Each section should include specific, measurable indicators relevant to the organization type
            - Consider the roadmap timeline and business architecture from previous phases
            
            IMPORTANT: Return ONLY valid JSON with keys: 
            "exec_kpis", "exec_csf", "project_metrics", "project_milestones", 
            "it_performance", "it_health", "security_metrics", "risk_indicators"`;

            const res = await callOpenAI(prompt, 'btn-dashboard', 'btn-dashboard-text', 'Generate Dashboard', false, { expectJson: true });
            if(res) {
                const data = parseJsonOrNotify(res, 'Dashboard');
                if (!data) return;
                
                // Executive Dashboard
                document.getElementById('input-exec-kpis').value = formatStructuredValue(data.exec_kpis);
                document.getElementById('input-exec-csf').value = formatStructuredValue(data.exec_csf);
                
                // Project Management Dashboard
                document.getElementById('input-project-metrics').value = formatStructuredValue(data.project_metrics);
                document.getElementById('input-project-milestones').value = formatStructuredValue(data.project_milestones);
                
                // IT Operations Dashboard
                document.getElementById('input-it-performance').value = formatStructuredValue(data.it_performance);
                document.getElementById('input-it-health').value = formatStructuredValue(data.it_health);
                
                // Security & Compliance Dashboard
                document.getElementById('input-security-metrics').value = formatStructuredValue(data.security_metrics);
                document.getElementById('input-risk-indicators').value = formatStructuredValue(data.risk_indicators);
                
                showToast('Dashboard KPIs generated successfully!', 'success');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save/export
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (currentStep === 'F') {
                    exportToTxt();
                }
            }
            
            // Ctrl/Cmd + P to print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Auto-save to localStorage
        setInterval(() => {
            const data = {};
            document.querySelectorAll('input[type="text"], textarea').forEach(element => {
                if (element.id && element.value) {
                    data[element.id] = element.value;
                }
            });
            localStorage.setItem('ea_builder_autosave', JSON.stringify(data));
        }, 30000); // Auto-save every 30 seconds

        // Load auto-saved data on page load
        window.addEventListener('load', () => {
            const savedData = localStorage.getItem('ea_builder_autosave');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    Object.keys(data).forEach(id => {
                        const element = document.getElementById(id);
                        if (element && !element.value) {
                            element.value = data[id];
                        }
                    });
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        });
    </script>
</body>
</html>
