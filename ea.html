<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA Builder Workflow - Powered by OpenAI GPT-5.2 mini</title>
    <!-- Google Fonts: Sarabun for professional Thai text -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* ===== COMPLETE FORM SYSTEM REDESIGN ===== */
        
        /* Reset and Base */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        /* Form Container System */
        .form-container {
            width: 100%;
            max-width: 100%;
        }
        
        .form-control,
        .form-textarea,
        .form-input {
            display: block;
            width: 100%;
            max-width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #ffffff;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: #374151;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            resize: none;
            overflow: hidden;
        }
        
        .form-control:focus,
        .form-textarea:focus,
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Auto-expanding textarea */
        .form-textarea {
            min-height: 80px;
            height: auto;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .input-group input,
            .input-group textarea,
            .input-group select,
            textarea,
            input[type="text"] {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .input-group input,
            .input-group textarea,
            .input-group select,
            textarea,
            input[type="text"] {
                padding: 8px;
                font-size: 13px;
                min-height: 60px;
            }
        }
        
        /* Grid System Fix */
        .form-grid {
            display: grid;
            gap: 1rem;
            width: 100%;
        }
        
        .form-grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .form-grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        /* ===== ULTIMATE CSS OVERRIDE SYSTEM ===== */
        
        /* Override ALL textarea styles with MAXIMUM specificity */
        .input-group textarea,
        textarea,
        form textarea,
        .form-textarea,
        [class*="textarea"] {
            all: unset !important;
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            padding: 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            background-color: #ffffff !important;
            font-family: 'Sarabun', sans-serif !important;
            font-size: 16px !important;
            line-height: 1.5 !important;
            color: #374151 !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
            resize: none !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
            height: auto !important;
            min-height: 80px !important;
            max-height: none !important;
        }
        
        /* Override ALL input styles */
        .input-group input,
        input[type="text"],
        input[type="password"],
        input[type="email"],
        .form-input,
        [class*="input"] {
            all: unset !important;
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            padding: 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            background-color: #ffffff !important;
            font-family: 'Sarabun', sans-serif !important;
            font-size: 16px !important;
            line-height: 1.5 !important;
            color: #374151 !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
            box-sizing: border-box !important;
        }
        
        /* Override ALL Tailwind form classes */
        .w-full textarea,
        .w-full input,
        .w-\[100\%\] textarea,
        .w-\[100\%\] input,
        .max-w-\[none\] textarea,
        .max-w-\[none\] input {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Override ANY grid or flex container that limits width */
        .grid textarea,
        .flex textarea,
        .grid input,
        .flex input {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Force override ANY inline styles */
        textarea[style],
        input[style] {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
        }
        
        /* Additional fixes for flex containers */
        .flex-1 textarea,
        .flex-initial textarea,
        .flex-none textarea,
        [class*="flex"] textarea {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
        }
        
        /* Fix for input-group containers */
        .input-group {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .input-group textarea,
        .input-group input {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
        }
        
        /* Fix for grid containers that might constrain width */
        [class*="grid"] [class*="input-group"],
        [class*="grid"] textarea,
        [class*="grid"] input {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Ensure containers don't constrain their children */
        .w-2\/3 textarea,
        .w-1\/3 textarea,
        .w-1\/2 textarea {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Enhanced Visual Hierarchy */
        .section-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(to right, #eff6ff, transparent);
            padding: 1rem 1rem 1rem 1rem;
            border-radius: 0.5rem;
        }
        
        .subsection-header {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        
        .status-complete {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-inprogress {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-missing {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* Enhanced Navigation */
        .nav-item {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-item.completed {
            background: linear-gradient(to right, #f0fdf4, #ffffff);
        }
        
        .nav-item.in-progress {
            background: linear-gradient(to right, #fef3c7, #ffffff);
        }
        
        .nav-item.missing {
            background: linear-gradient(to right, #fef2f2, #ffffff);
        }
        
        /* Notification Area */
        .notification-area {
            position: fixed;
            top: 4rem;
            right: 1rem;
            z-index: 50;
            max-width: 400px;
        }
        
        .notification {
            background: white;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Strategic Thinking Helpers */
        .strategic-hint {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            color: #0c4a6e;
        }
        
        .strategic-hint i {
            color: #0284c7;
            margin-right: 0.5rem;
        }
        
        /* Enhanced AI Buttons */
        .btn-enhanced-ai {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn-enhanced-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        
        .btn-enhanced-ai::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-enhanced-ai:hover::before {
            left: 100%;
        }

        /* Flowchart Node Styling */
        .node-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 5px solid transparent;
        }
        .node-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .node-card.active {
            border-left-width: 5px;
            background-color: #ffffff;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        /* Specific Colors matching Mermaid Graph */
        .theme-A { border-left-color: #60a5fa; background-color: #eff6ff; } /* Context: Blue */
        .theme-B { border-left-color: #4ade80; background-color: #f0fdf4; } /* DM: Green */
        .theme-C { border-left-color: #fbbf24; background-color: #fffbeb; } /* BM: Amber */
        .theme-D { border-left-color: #fb7185; background-color: #fff1f2; } /* RM: Rose */
        .theme-E { border-left-color: #38bdf8; background-color: #ecfeff; } /* Security: Cyan */
        .theme-F { border-left-color: #a78bfa; background-color: #f5f3ff; } /* Output: Violet */

        .step-content {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }

        /* AI Button Styling */
        .btn-ai {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            color: white;
            transition: all 0.3s ease;
            border: none;
        }
        .btn-ai:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(185, 28, 28, 0.4);
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        .btn-ai-light {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            transition: all 0.2s;
        }
        .btn-ai-light:hover {
            background-color: #fecaca;
            border-color: #f87171;
        }
        
        .btn-ai-field {
            font-size: 0.75rem;
            color: #ef4444;
            background-color: #fef2f2;
            border: 1px solid #fee2e2;
            padding: 4px 10px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-ai-field:hover {
            background-color: #fee2e2;
            border-color: #fecaca;
        }

        /* Print Styling */
        @media print {
            body { background-color: white; }
            aside, header, .btn-ai, .btn-ai-field, button { display: none !important; }
            .step-content { display: block !important; opacity: 1 !important; }
            .step-content > div { page-break-inside: avoid; margin-bottom: 2rem; border: none !important; shadow: none !important; }
            textarea { border: none; resize: none; overflow: visible; height: auto; font-family: 'Sarabun', serif; }
            input { border: none; }
            /* Hide non-essential UI elements for print */
            .fa-wand-magic-sparkles, .fa-gear, .fa-download { display: none; }
            #final-summary-preview { display: block !important; }
        }

        .loading-spinner-dark {
             border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid #b91c1c;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 50;
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- API Key Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-key text-red-500 mr-2"></i>ตั้งค่า OpenAI API Key</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4">โปรดระบุ OpenAI API Key (sk-...)</p>
            <div class="input-group mb-6">
                <input type="password" id="api-key-input" placeholder="sk-..." class="font-mono text-sm">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">ยกเลิก</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">บันทึก</button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-10 flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-red-600 to-orange-600 text-white p-2 rounded-lg shadow-md">
                    <i class="fa-solid fa-sitemap text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        EA Workflow Builder
                        <span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700 border border-red-200">
                            <i class="fa-solid fa-robot mr-1"></i>OpenAI GPT-5.2 mini
                        </span>
                    </h1>
                    <p class="text-xs text-gray-500">สำหรับคุณวิรุณ เวชศิริ (Pharm Connection / IT Ph.D.)</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="exportToTxt()" class="text-gray-600 hover:text-blue-600 px-3 py-1 rounded border border-gray-300 hover:bg-gray-50 text-sm transition" title="Download Text File">
                    <i class="fa-solid fa-file-lines mr-1"></i> Save TXT
                </button>
                <button onclick="window.print()" class="text-gray-600 hover:text-red-600 px-3 py-1 rounded border border-gray-300 hover:bg-gray-50 text-sm transition" title="Print or Save as PDF">
                    <i class="fa-solid fa-print mr-1"></i> Print / PDF
                </button>
                <div class="h-6 w-px bg-gray-300 mx-1"></div>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100 transition" title="ตั้งค่า API Key">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        
        <!-- Sidebar Navigation -->
        <aside class="w-80 bg-white border-r border-gray-200 flex-none overflow-y-auto hidden md:block">
            <div class="p-4">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Architecture Phases</h2>
                <div class="space-y-3 relative">
                    <div class="absolute left-6 top-4 bottom-4 w-0.5 bg-gray-200 -z-10"></div>
                    <!-- Navigation Items -->
                    <div onclick="switchStep('A')" id="nav-A" class="nav-item node-card theme-A p-3 rounded-lg flex items-center gap-3 relative z-10">
                        <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold shadow-sm">1</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-gray-800">การวิเคราะห์บริบท</h3>
                            <p class="text-xs text-gray-500">Context Analysis</p>
                        </div>
                    </div>
                    <div onclick="switchStep('B')" id="nav-B" class="nav-item node-card theme-B p-3 rounded-lg flex items-center gap-3 relative z-10">
                        <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold shadow-sm">2</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-gray-800">การจัดการทิศทาง</h3>
                            <p class="text-xs text-gray-500">Direction Management</p>
                        </div>
                    </div>
                    <div onclick="switchStep('C')" id="nav-C" class="nav-item node-card theme-C p-3 rounded-lg flex items-center gap-3 relative z-10">
                        <div class="w-8 h-8 rounded-full bg-yellow-500 text-white flex items-center justify-center text-xs font-bold shadow-sm">3</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-gray-800">แผนงานสถาปัตยกรรม</h3>
                            <p class="text-xs text-gray-500">Blueprint Management</p>
                        </div>
                    </div>
                    <div onclick="switchStep('D')" id="nav-D" class="nav-item node-card theme-D p-3 rounded-lg flex items-center gap-3 relative z-10">
                        <div class="w-8 h-8 rounded-full bg-rose-400 text-white flex items-center justify-center text-xs font-bold shadow-sm">4</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-gray-800">แผนที่เส้นทาง</h3>
                            <p class="text-xs text-gray-500">Roadmap Management</p>
                        </div>
                    </div>
                    <div onclick="switchStep('E')" id="nav-E" class="nav-item node-card theme-E p-3 rounded-lg flex items-center gap-3 relative z-10">
                        <div class="w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center text-xs font-bold shadow-sm">5</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-gray-800">ความั่นคงปลอดภัย</h3>
                            <p class="text-xs text-gray-500">Cybersecurity</p>
                        </div>
                    </div>
                    <div onclick="switchStep('F')" id="nav-F" class="nav-item node-card theme-F p-3 rounded-lg flex items-center gap-3 relative z-10">
                        <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center text-xs font-bold shadow-sm">6</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-gray-800">ผลลัพธ์และติดตาม</h3>
                            <p class="text-xs text-gray-500">Output & Monitor</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Notification Area -->
        <div id="notification-area" class="notification-area"></div>

        <!-- Main Workspace -->
        <main class="flex-1 bg-gray-50 overflow-y-auto p-4 sm:p-8 relative">
            
            <!-- Welcome Screen -->
            <div id="content-welcome" class="step-content active max-w-3xl mx-auto text-center pt-10">
                <div class="inline-block p-6 rounded-full bg-gradient-to-br from-red-50 to-orange-50 mb-6 relative">
                    <i class="fa-solid fa-network-wired text-6xl text-red-600"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 mb-4">ยินดีต้อนรับสู่ระบบ EA Builder AI</h2>
                <p class="text-gray-600 mb-8 max-w-xl mx-auto">
                    เครื่องมือช่วยสร้างสถาปัตยกรรมองค์กรอัจฉริยะ ผสานพลัง <strong>OpenAI GPT-5.2 mini</strong> ช่วยวิเคราะห์บริบท ร่างวิสัยทัศน์ และออกแบบโครงสร้างแบบ End-to-End
                </p>
                <button onclick="switchStep('A')" class="bg-red-600 text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:bg-red-700 transition">
                    เริ่มสร้าง Architecture <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- Step A: Context Analysis -->
            <div id="content-A" class="step-content max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <div>
                        <span class="text-blue-600 font-bold uppercase tracking-wide text-xs">Phase 1</span>
                        <h2 class="text-2xl font-bold text-gray-800">การวิเคราะห์บริบท (Context Analysis)</h2>
                    </div>
                </div>

                <!-- Strategic Hint -->
                <div class="strategic-hint">
                    <i class="fa-solid fa-lightbulb"></i>
                    <strong>เคล็ดลับเชิงกลยุทธ์:</strong> เริ่มต้นด้วยการกำหนดประเภทองค์กรให้ชัดเจน จะช่วยให้ AI วิเคราะห์ SWOT ได้แม่นยำและเหมาะสมกับธุรกิจของคุณมากขึ้น
                </div>

                <!-- NEW: Enhanced Org Input -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 mb-6">
                    <h3 class="section-header text-lg">ข้อมูลพื้นฐานองค์กร</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="flex gap-4">
                            <div class="w-1/3">
                                <label class="text-xs font-bold text-gray-500 uppercase">ประเภทองค์กร / ธุรกิจ</label>
                                <input type="text" id="ai-input-org-type" class="input-field" placeholder="เช่น ร้านยาชุมชน, บริษัท Logistics, โรงพยาบาลเอกชน">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs font-bold text-gray-500 uppercase">คำอธิบายสังเขป (Short Description)</label>
                                <textarea id="ai-input-org-desc" class="form-textarea" placeholder="เช่น เน้นบริการผู้ป่วยเรื้อรัง ต้องการนำ RPA มาใช้ลดงานเอกสาร มีปัญหาด้านการจัดการสต็อกยา..."></textarea>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="generateSWOT()" id="btn-swot" class="btn-enhanced-ai text-sm px-6 py-3 rounded-lg shadow-md flex items-center whitespace-nowrap">
                                <span id="btn-swot-icon"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i></span>
                                <span id="btn-swot-text">วิเคราะห์ SWOT อัตโนมัติ</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Internal -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-lg mb-4 text-blue-800 border-b pb-2">Internal Factors (ภายใน)</h3>
                        <div class="space-y-4">
                            <div class="input-group">
                                <label>
                                    Strengths (จุดแข็ง)
                                    <button onclick="generateSingleField('input-strengths', 'Strengths (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-strengths" class="form-textarea" placeholder="เช่น ทีมงานมีความเชี่ยวชาญ..."></textarea>
                            </div>
                            <div class="input-group">
                                <label>
                                    Weaknesses (จุดอ่อน)
                                    <button onclick="generateSingleField('input-weaknesses', 'Weaknesses (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-weaknesses" class="form-textarea" placeholder="เช่น ขาดแคลนบุคลากรด้าน IT..."></textarea>
                            </div>
                        </div>
                    </div>
                    <!-- External -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                         <h3 class="font-bold text-lg mb-4 text-blue-800 border-b pb-2">External Factors (ภายนอก)</h3>
                         <div class="space-y-4">
                            <div class="input-group">
                                <label>
                                    Opportunities (โอกาส)
                                    <button onclick="generateSingleField('input-opportunities', 'Opportunities (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-opportunities" class="form-textarea" placeholder="เช่น นโยบาย Telemedicine..."></textarea>
                            </div>
                             <div class="input-group">
                                <label>
                                    Threats (อุปสรรค)
                                    <button onclick="generateSingleField('input-threats', 'Threats (SWOT)')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-threats" class="form-textarea" placeholder="เช่น กฎระเบียบที่เข้มงวด..."></textarea>
                            </div>
                         </div>
                    </div>
                    <!-- Context -->
                    <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-lg mb-4 text-blue-800 border-b pb-2">Strategic Context</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="input-group">
                                <label>
                                    Constraints (ข้อจำกัดหลัก)
                                    <button onclick="generateSingleField('input-constraints', 'Strategic Constraints')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-constraints" class="form-textarea" placeholder="งบประมาณ, กฎหมาย PDPA..."></textarea>
                            </div>
                            <div class="input-group">
                                <label>
                                    Vision & Mission
                                    <button onclick="generateSingleField('input-vision', 'Vision and Mission statement')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                </label>
                                <textarea id="input-vision" class="form-textarea" placeholder="ระบุวิสัยทัศน์พันธกิจ..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Next Button -->
                <div class="mt-8 flex justify-end">
                    <button onclick="switchStep('B')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium shadow-md flex items-center">
                        Next: Direction Management (DM) <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step B: Direction Management -->
            <div id="content-B" class="step-content max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <div>
                        <span class="text-green-600 font-bold uppercase tracking-wide text-xs">Phase 2</span>
                        <h2 class="text-2xl font-bold text-gray-800">การจัดการทิศทาง (Direction Management)</h2>
                    </div>
                </div>

                <!-- Strategic Hint -->
                <div class="strategic-hint">
                    <i class="fa-solid fa-compass"></i>
                    <strong>เคล็ดลับเชิงกลยุทธ์:</strong> การวางทิศทางที่ชัดเจนจะเชื่อมโยง SWOT จาก Phase 1 กับเป้าหมายอนาคต คิดว่า "จะเปลี่ยนจุดอ่อนเป็นจุดแข็งอย่างไร และจะใช้โอกาสให้เกิดประโยชน์สูงสุดอย่างไร"
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-green-100 mb-6">
                    <h3 class="section-header">กรอบคิดเชิงยุทธศาสตร์</h3>
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4 rounded">
                        <p class="text-sm text-green-800">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            AI จะนำข้อมูล Context จาก Phase 1 มาช่วยคิดในส่วนนี้โดยอัตโนมัติ
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label>
                                Global Trends & Drivers
                                <button onclick="generateSingleField('input-trends', 'Global Trends')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                            </label>
                            <textarea id="input-trends" class="form-textarea" placeholder="AI in Healthcare, Telepharmacy..."></textarea>
                        </div>
                        <div class="input-group">
                            <label>
                                Stakeholder Expectations
                                <button onclick="generateSingleField('input-stakeholders', 'Stakeholder Expectations')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                            </label>
                            <textarea id="input-stakeholders" class="form-textarea" placeholder="ลูกค้าต้องการความรวดเร็ว..."></textarea>
                        </div>
                        <div class="input-group md:col-span-2">
                            <label>
                                Strategic Intent / Goals
                                <button onclick="generateSingleField('input-goals', 'Strategic Intent / Goals')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                            </label>
                            <textarea id="input-goals" class="form-textarea" placeholder="เป้าหมายเชิงกลยุทธ์..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                    <div class="input-group">
                         <label class="text-green-900">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-gavel"></i> Design Principles & Enablers</span>
                            <button onclick="generateSingleField('input-principles', 'IT Design Principles')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                         </label>
                         <textarea id="input-principles" class="form-textarea bg-white" placeholder="- Mobile First Design&#10;- Zero Trust Security..."></textarea>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="switchStep('A')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                    <button onclick="switchStep('C')" class="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600 transition font-medium shadow-md flex items-center">
                        Next: Blueprint Management (BM) <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step C: Blueprint Management -->
            <div id="content-C" class="step-content max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <div>
                        <span class="text-yellow-600 font-bold uppercase tracking-wide text-xs">Phase 3</span>
                        <h2 class="text-2xl font-bold text-gray-800">แผนงานสถาปัตยกรรม (Blueprint Management)</h2>
                    </div>
                    <button onclick="generateBlueprint()" id="btn-blueprint" class="btn-enhanced-ai text-sm px-4 py-2 rounded-lg shadow-md flex items-center">
                        <span id="btn-blueprint-icon"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i></span>
                        <span id="btn-blueprint-text">สร้าง Blueprint อัตโนมัติ</span>
                    </button>
                </div>

                <!-- Strategic Hint -->
                <div class="strategic-hint">
                    <i class="fa-solid fa-drafting-compass"></i>
                    <strong>เคล็ดลับเชิงกลยุทธ์:</strong> การออกแบบ Blueprint คือการแปลงวิสัยทัศน์ให้เป็นรูปธรรม จัดลำดับความสำคัญ และสร้างฐานข้อมูลที่เชื่อมโยงกันระหว่าง Business, Data และ Technology
                </div>

                <div class="space-y-6">
                    <!-- Business Arch -->
                    <div class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 shadow-sm">
                        <h4 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-briefcase text-yellow-500"></i> 1. Business Architecture
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label class="text-sm">Front Office <button onclick="generateSingleField('input-biz-front', 'Front Office Capabilities (Bullet points)')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-biz-front" class="form-textarea" placeholder="- Channel A&#10;- CRM System"></textarea>
                        </div>
                        <div class="input-group">
                            <label class="text-sm">Core Operations <button onclick="generateSingleField('input-biz-core', 'Core Operations (Bullet points)')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-biz-core" class="form-textarea" placeholder="- Order Mgmt&#10;- Production"></textarea>
                        </div>
                        <div class="input-group">
                            <label class="text-sm">Back Office <button onclick="generateSingleField('input-biz-back', 'Back Office Capabilities (Bullet points)')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-biz-back" class="form-textarea" placeholder="- HR System&#10;- Accounting"></textarea>
                        </div>
                        </div>
                    </div>

                    <!-- Data & Tech -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 shadow-sm">
                            <div class="input-group">
                                <label>
                                    <span class="flex items-center gap-2"><i class="fa-solid fa-database text-yellow-500"></i> 2. Data Architecture</span>
                                    <button onclick="generateSingleField('input-data-arch', 'Data Architecture')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                 </label>
                                <textarea id="input-data-arch" rows="4" placeholder="Master Data Entities..."></textarea>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 shadow-sm">
                            <div class="input-group">
                                <label>
                                    <span class="flex items-center gap-2"><i class="fa-solid fa-server text-yellow-500"></i> 3. Technology Architecture</span>
                                    <button onclick="generateSingleField('input-tech-arch', 'Technology Architecture')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button>
                                 </label>
                                <textarea id="input-tech-arch" rows="4" placeholder="Platforms, Cloud..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="switchStep('B')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                    <button onclick="switchStep('D')" class="bg-rose-500 text-white px-6 py-3 rounded-lg hover:bg-rose-600 transition font-medium shadow-md flex items-center">
                        Next: Roadmap Management (RM) <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step D: Roadmap Management -->
            <div id="content-D" class="step-content max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <div>
                        <span class="text-rose-600 font-bold uppercase tracking-wide text-xs">Phase 4</span>
                        <h2 class="text-2xl font-bold text-gray-800">Roadmap Management (RM)</h2>
                    </div>
                    <button onclick="generateRoadmap()" id="btn-roadmap" class="btn-ai text-xs px-3 py-2 rounded shadow-sm flex items-center">
                         <span id="btn-roadmap-icon"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i></span>
                         <span id="btn-roadmap-text">Auto Roadmap</span>
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-rose-800">Transition Architecture (Timeline)</h3>
                    <div class="space-y-4">
                        <div class="input-group pl-4 border-l-4 border-rose-200">
                            <label>Short Term (Quick Wins) <button onclick="generateSingleField('input-short-term', 'Short Term Roadmap')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-short-term" rows="3" class="bg-gray-50" placeholder="โครงการระยะสั้น..."></textarea>
                        </div>
                        <div class="input-group pl-4 border-l-4 border-rose-300">
                            <label>Medium Term (Expansion) <button onclick="generateSingleField('input-medium-term', 'Medium Term Roadmap')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-medium-term" rows="3" class="bg-gray-50" placeholder="โครงการระยะกลาง..."></textarea>
                        </div>
                        <div class="input-group pl-4 border-l-4 border-rose-400">
                            <label>Long Term (Transformation) <button onclick="generateSingleField('input-long-term', 'Long Term Roadmap')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-long-term" rows="3" class="bg-gray-50" placeholder="โครงการระยะยาว..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100">
                    <h3 class="font-bold text-lg mb-4">Balanced Scorecard KPIs</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-sm font-bold text-yellow-700">Finance <button onclick="generateSingleField('input-bsc-finance', 'Financial KPIs')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-bsc-finance" rows="2" placeholder="ROI, Cost..."></textarea>
                        </div>
                        <div class="input-group">
                            <label class="text-sm font-bold text-blue-700">Customer <button onclick="generateSingleField('input-bsc-customer', 'Customer KPIs')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-bsc-customer" rows="2" placeholder="Satisfaction..."></textarea>
                        </div>
                        <div class="input-group">
                            <label class="text-sm font-bold text-green-700">Internal Process <button onclick="generateSingleField('input-bsc-process', 'Process KPIs')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-bsc-process" rows="2" placeholder="Efficiency..."></textarea>
                        </div>
                        <div class="input-group">
                            <label class="text-sm font-bold text-purple-700">Learning & Growth <button onclick="generateSingleField('input-bsc-learning', 'Learning KPIs')" class="btn-ai-field"><i class="fa-solid fa-wand-magic-sparkles"></i></button></label>
                            <textarea id="input-bsc-learning" rows="2" placeholder="Upskill..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="switchStep('C')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                    <button onclick="switchStep('E')" class="bg-cyan-500 text-white px-6 py-3 rounded-lg hover:bg-cyan-600 transition font-medium shadow-md flex items-center">
                        Next: Cybersecurity <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step E: Security & Governance -->
            <div id="content-E" class="step-content max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <div>
                        <span class="text-cyan-600 font-bold uppercase tracking-wide text-xs">Phase 5</span>
                        <h2 class="text-2xl font-bold text-gray-800">Cybersecurity & Governance Layer</h2>
                    </div>
                    <button onclick="generateSecurity()" id="btn-security" class="btn-ai text-xs px-3 py-2 rounded shadow-sm flex items-center">
                         <span id="btn-security-icon"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i></span>
                         <span id="btn-security-text">Auto Analyze</span>
                    </button>
                </div>

                <div class="bg-cyan-50 border border-cyan-200 rounded-xl p-6 mb-6">
                    <p class="text-cyan-800 mb-6 text-sm">
                        <i class="fa-solid fa-info-circle mr-1"></i> Cross-cutting Architecture 5 มิติ
                    </p>
                    
                    <div class="space-y-6">
                        <!-- 5 Security Controls -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100"><div class="input-group"><label class="text-cyan-800">1. Governance & Policy <button onclick="generateSingleField('input-gov', 'Security Governance & Policy')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button></label><textarea id="input-gov" rows="3" placeholder="ระบุผู้รับผิดชอบ..."></textarea></div></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100"><div class="input-group"><label class="text-cyan-800">2. Risk Identification <button onclick="generateSingleField('input-risk', 'Cybersecurity Risk Analysis')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button></label><textarea id="input-risk" rows="3" placeholder="ความเสี่ยงหลัก..."></textarea></div></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100"><div class="input-group"><label class="text-cyan-800">3. Protection Controls <button onclick="generateSingleField('input-protect', 'Cybersecurity Protection Controls')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button></label><textarea id="input-protect" rows="3" placeholder="มาตรการป้องกัน..."></textarea></div></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100"><div class="input-group"><label class="text-cyan-800">4. Detection Controls <button onclick="generateSingleField('input-detect', 'Cybersecurity Detection Controls')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button></label><textarea id="input-detect" rows="3" placeholder="มาตรการตรวจับ..."></textarea></div></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-cyan-100"><div class="input-group"><label class="text-cyan-800">5. Response & Recovery <button onclick="generateSingleField('input-respond', 'Cybersecurity Response & Recovery Plan')" class="btn-ai-field" title="Auto-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> AI</button></label><textarea id="input-respond" rows="3" placeholder="แผนกู้คืน..."></textarea></div></div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="switchStep('D')" class="text-gray-500 hover:text-gray-800">กลับไปก่อนหน้า</button>
                    <button onclick="switchStep('F')" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition font-medium shadow-md flex items-center">
                        Next: Output & Monitor <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

             <!-- Step F: Output & Monitoring -->
             <div id="content-F" class="step-content max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6 border-b pb-4">
                    <div>
                        <span class="text-purple-600 font-bold uppercase tracking-wide text-xs">Phase 6</span>
                        <h2 class="text-2xl font-bold text-gray-800">EA Output & Monitoring</h2>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-purple-400 mb-8">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="inline-block p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fa-solid fa-file-contract text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Final EA Document Preview</h3>
                            <p class="text-sm text-gray-500">สรุปข้อมูลจากทุกขั้นตอน (Phase 1-5)</p>
                        </div>
                    </div>
                    
                    <!-- SUMMARY PREVIEW AREA -->
                    <div id="final-summary-preview" class="bg-gray-50 p-6 rounded-lg border border-gray-200 text-sm text-gray-700 leading-relaxed mb-6 font-mono whitespace-pre-wrap h-96 overflow-y-auto">
                        <!-- Content will be auto-populated here -->
                    </div>
                    
                    <div class="flex justify-center gap-4 border-t pt-6">
                        <button onclick="exportToTxt()" class="px-6 py-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition flex items-center">
                            <i class="fa-solid fa-file-lines mr-2"></i> Download Text File
                        </button>
                        <button onclick="window.print()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition flex items-center">
                            <i class="fa-solid fa-print mr-2"></i> Print / Save as PDF
                        </button>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-start">
                    <button onclick="switchStep('E')" class="text-gray-500 hover:text-gray-800">กลับไปแก้ไข</button>
                </div>
            </div>

        </main>
    </div>

    <!-- Script -->
    <script>
        const apiKey = ""; 
        let manualApiKey = localStorage.getItem('ea_builder_api_key') || '';
        const OPENAI_SYSTEM_PROMPT = `You are an AI assistant specialized in Enterprise Architecture (EA), designed to support strategic planning, system design, and organizational alignment across business, data, application, and technology layers.

You help users analyze complex organizations, clarify business capabilities, map processes, design target architectures, and evaluate trade-offs between people, process, and technology. You can assist with frameworks such as TOGAF, Zachman, ArchiMate, BMC, or custom EA models, while adapting explanations to user's level of technical understanding.

You provide clear, structured, and honest guidance without unnecessary affirmations or filler phrases. You respond directly and thoughtfully to each request, focusing on reasoning, structure, and practical applicability rather than buzzwords.

You always respond in the language used by the user.
Your writing style is professional, clear, and conversational, showing genuine interest in understanding the organizational context, constraints, and goals. You express appropriate empathy when discussing real-world challenges such as legacy systems, organizational resistance, resource limitations, or regulatory constraints.

Your primary goal is to help the user:
- Understand the current-state architecture
- Design a future-state (target) architecture
- Define transition roadmaps
- Make informed architectural decisions that align strategy, operations, and technology.`;

        document.addEventListener('DOMContentLoaded', () => {
             if(manualApiKey) document.getElementById('api-key-input').value = manualApiKey;
             
             // Initialize auto-expanding textareas
             initializeAutoExpand();
             
             // Initialize progress tracking
             updateAllNavigationStatus();
             
             // Add input listeners for progress tracking
             addInputListeners();
        });

        // Auto-expanding textarea functionality
        function initializeAutoExpand() {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.classList.add('auto-expand');
                textarea.addEventListener('input', autoExpand);
                textarea.addEventListener('focus', autoExpand);
                
                // Initial height adjustment
                autoExpand.call(textarea);
            });
        }

        function autoExpand() {
            this.style.height = 'auto';
            this.style.height = Math.max(80, this.scrollHeight) + 'px';
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            // Set border color based on type
            const colors = {
                'success': '#10b981',
                'error': '#ef4444',
                'warning': '#f59e0b',
                'info': '#3b82f6'
            };
            notification.style.borderLeftColor = colors[type] || colors.info;
            
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mt-1"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `;
            
            notificationArea.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Progress tracking
        function getPhaseStatus(phaseId) {
            const requiredFields = getRequiredFieldsForPhase(phaseId);
            let filledCount = 0;
            let totalCount = requiredFields.length;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim().length > 0) {
                    filledCount++;
                }
            });
            
            if (filledCount === 0) return 'missing';
            if (filledCount === totalCount) return 'complete';
            return 'in-progress';
        }

        function getRequiredFieldsForPhase(phaseId) {
            const fieldMap = {
                'A': ['ai-input-org-type', 'ai-input-org-desc', 'input-strengths', 'input-weaknesses', 'input-opportunities', 'input-threats', 'input-constraints', 'input-vision'],
                'B': ['input-trends', 'input-stakeholders', 'input-goals', 'input-principles'],
                'C': ['input-biz-front', 'input-biz-core', 'input-biz-back', 'input-data-arch', 'input-tech-arch'],
                'D': ['input-short-term', 'input-medium-term', 'input-long-term', 'input-bsc-finance', 'input-bsc-customer', 'input-bsc-process', 'input-bsc-learning'],
                'E': ['input-gov', 'input-risk', 'input-protect', 'input-detect', 'input-respond'],
                'F': [] // Output phase doesn't have input fields
            };
            return fieldMap[phaseId] || [];
        }

        function updateNavigationStatus(phaseId) {
            const navItem = document.getElementById(`nav-${phaseId}`);
            const status = getPhaseStatus(phaseId);
            
            // Remove existing status classes
            navItem.classList.remove('completed', 'in-progress', 'missing');
            
            // Add new status class
            navItem.classList.add(status);
            
            // Add or update status indicator
            let statusIndicator = navItem.querySelector('.status-indicator');
            if (!statusIndicator) {
                statusIndicator = document.createElement('span');
                statusIndicator.className = 'status-indicator ml-2';
                navItem.querySelector('div').appendChild(statusIndicator);
            }
            
            // Update status indicator content
            const statusConfig = {
                'complete': { class: 'status-complete', icon: 'fa-check', text: 'สมบูรณ์' },
                'in-progress': { class: 'status-inprogress', icon: 'fa-clock', text: 'กำลังทำ' },
                'missing': { class: 'status-missing', icon: 'fa-exclamation', text: 'ยังไม่ได้กรอก' }
            };
            
            const config = statusConfig[status];
            statusIndicator.className = `status-indicator ml-2 ${config.class}`;
            statusIndicator.innerHTML = `<i class="fa-solid ${config.icon} text-xs"></i> ${config.text}`;
        }

        function updateAllNavigationStatus() {
            ['A', 'B', 'C', 'D', 'E', 'F'].forEach(phaseId => {
                updateNavigationStatus(phaseId);
            });
        }

        function addInputListeners() {
            const allInputs = document.querySelectorAll('input[type="text"], textarea');
            allInputs.forEach(input => {
                input.addEventListener('input', () => {
                    // Debounce status updates
                    clearTimeout(input.updateTimeout);
                    input.updateTimeout = setTimeout(() => {
                        updateAllNavigationStatus();
                    }, 300);
                });
            });
        }

        // Enhanced step switching with validation
        function switchStepWithValidation(stepId) {
            const currentStep = document.querySelector('.step-content.active').id.replace('content-', '');
            const currentStatus = getPhaseStatus(currentStep);
            
            if (currentStatus !== 'complete' && currentStatus !== 'in-progress') {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วนก่อนไปยังขั้นตอนถัดไป', 'warning');
                return;
            }
            
            switchStep(stepId);
        }

        // Safe value getter
        const getVal = (id) => document.getElementById(id)?.value || "";

        // Context Collector: Gathers all filled data to feed AI memory
        function collectContext() {
            return `
            Context Data (User Input So Far):
            - Org Type: ${getVal('ai-input-org-type')}
            - Org Description: ${getVal('ai-input-org-desc')}
            - SWOT Strengths: ${getVal('input-strengths')}
            - SWOT Weaknesses: ${getVal('input-weaknesses')}
            - Vision/Mission: ${getVal('input-vision')}
            - Strategic Goals: ${getVal('input-goals')}
            - Trends: ${getVal('input-trends')}
            - Stakeholders: ${getVal('input-stakeholders')}
            `;
        }

        function switchStep(stepId) {
            document.querySelectorAll('.node-card').forEach(item => item.classList.remove('active', 'ring-2', 'ring-offset-1', 'ring-blue-300'));
            document.getElementById(`nav-${stepId}`).classList.add('active', 'ring-2', 'ring-offset-1', 'ring-blue-300');
            document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`content-${stepId}`).classList.add('active');
            document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });

            // Auto Render Summary when entering Phase F
            if (stepId === 'F') {
                renderSummary();
            }
        }

        function renderSummary() {
            let content = "=== Enterprise Architecture Report ===\n\n";
            content += `[Organization]: ${getVal('ai-input-org-type')} - ${getVal('ai-input-org-desc')}\n\n`;
            
            content += "--- PHASE 1: CONTEXT ---\n";
            content += `Strengths:\n${getVal('input-strengths')}\n\n`;
            content += `Weaknesses:\n${getVal('input-weaknesses')}\n\n`;
            content += `Opportunities:\n${getVal('input-opportunities')}\n\n`;
            content += `Threats:\n${getVal('input-threats')}\n\n`;
            content += `Constraints: ${getVal('input-constraints')}\n`;
            content += `Vision: ${getVal('input-vision')}\n\n`;

            content += "--- PHASE 2: DIRECTION ---\n";
            content += `Trends: ${getVal('input-trends')}\n`;
            content += `Stakeholders: ${getVal('input-stakeholders')}\n`;
            content += `Goals:\n${getVal('input-goals')}\n`;
            content += `Principles:\n${getVal('input-principles')}\n\n`;

            content += "--- PHASE 3: BLUEPRINT ---\n";
            content += `Front Office:\n${getVal('input-biz-front')}\n\n`;
            content += `Core Ops:\n${getVal('input-biz-core')}\n\n`;
            content += `Back Office:\n${getVal('input-biz-back')}\n\n`;
            content += `Data Arch:\n${getVal('input-data-arch')}\n\n`;
            content += `Tech Arch:\n${getVal('input-tech-arch')}\n\n`;

            content += "--- PHASE 4: ROADMAP ---\n";
            content += `Short Term: ${getVal('input-short-term')}\n`;
            content += `Medium Term: ${getVal('input-medium-term')}\n`;
            content += `Long Term: ${getVal('input-long-term')}\n\n`;

            content += "--- PHASE 5: SECURITY ---\n";
            content += `Governance: ${getVal('input-gov')}\n`;
            content += `Risks: ${getVal('input-risk')}\n`;
            content += `Controls: ${getVal('input-protect')}, ${getVal('input-detect')}, ${getVal('input-respond')}\n`;

            document.getElementById('final-summary-preview').textContent = content;
        }

        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('active'); }
        function toggleReport() { document.getElementById('report-modal').classList.toggle('active'); }
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if(key) {
                manualApiKey = key;
                localStorage.setItem('ea_builder_api_key', key);
                alert('API Key Saved!');
                toggleSettings();
            } else { alert('Please enter a valid API Key'); }
        }

        // --- Export Functions ---
        function exportToTxt() {
            renderSummary(); // Ensure latest data
            const content = document.getElementById('final-summary-preview').textContent;
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "EA_Report.txt";
            a.click();
            URL.revokeObjectURL(url);
        }

        function extractTextFromOpenAIRaw(raw) {
            if (!raw || !Array.isArray(raw.output)) return '';
            return raw.output
                .filter(part => part.type === 'message')
                .map(part => {
                    const chunks = Array.isArray(part.content)
                        ? part.content
                            .filter(chunk => chunk.type === 'output_text' || chunk.type === 'summary_text')
                            .map(chunk => chunk.text)
                        : [];
                    return chunks.join('\n').trim();
                })
                .join('\n\n')
                .trim();
        }

        // --- OpenAI API ---
        async function callOpenAI(prompt, buttonId, textId, originalText, isIcon = false, options = {}) {
            let effectiveApiKey = apiKey || manualApiKey;
            if (!effectiveApiKey) { alert('กรุณาตั้งค่า OpenAI API Key'); toggleSettings(); return null; }

            const button = buttonId ? document.getElementById(buttonId) : null;
            const textSpan = textId ? document.getElementById(textId) : null;
            const iconSpan = buttonId ? document.getElementById(buttonId + '-icon') : null;
            const btnElement = buttonId ? null : event.currentTarget;

            let originalContent = "";
            if (button) {
                originalContent = iconSpan.innerHTML;
                if(textSpan) textSpan.innerText = ' Thinking...';
                button.disabled = true;
                iconSpan.innerHTML = '<span class="loading-spinner-dark"></span>';
            } else if (btnElement) {
                originalContent = btnElement.innerHTML;
                btnElement.disabled = true;
                btnElement.innerHTML = '<span class="loading-spinner-dark"></span>';
            }

            try {
                const requestPayload = {
                    model: 'gpt-5-mini',
                    input: [
                        {
                            role: 'system',
                            content: [{ type: 'input_text', text: OPENAI_SYSTEM_PROMPT }]
                        },
                        {
                            role: 'user',
                            content: [{ type: 'input_text', text: prompt }]
                        }
                    ],
                    text: {
                        format: { type: 'text' },
                        verbosity: options.expectJson ? 'low' : 'medium'
                    },
                    reasoning: {
                        effort: options.reasoning_effort || 'medium',
                        summary: 'auto'
                    },
                    tools: [],
                    store: typeof options.store === 'boolean' ? options.store : true,
                    include: ["reasoning.encrypted_content", "web_search_call.action.sources"],
                    max_output_tokens: Math.min(1200, options.max_output_tokens || 600)
                };

                const response = await fetch('https://api.openai.com/v1/responses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${effectiveApiKey}` },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 401) {
                        throw new Error("Invalid OpenAI API Key. Please check your settings.");
                    }
                    throw new Error(`API Request Failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                const aiText = extractTextFromOpenAIRaw(data);
                if (aiText) return aiText;
                throw new Error("No AI response");
            } catch (error) {
                console.error(error); 
                if (error.message.includes("Invalid OpenAI API Key")) {
                    alert("⚠️ API Key ไม่ถูกต้อง กรุณาตรวจสอบ Key ในเมนูตั้งค่า (⚙️) ครับ");
                    toggleSettings(); // Auto open settings
                } else {
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
                return null;
            } finally {
                if (button) {
                    if(textSpan) textSpan.innerText = originalText;
                    iconSpan.innerHTML = originalContent;
                    button.disabled = false;
                } else if (btnElement) {
                    btnElement.innerHTML = originalContent;
                    btnElement.disabled = false;
                }
            }
        }

        // Updated Generator Functions with Context
        async function generateSingleField(fieldId, topic) {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Based on the context above (especially previous inputs), write concise Thai content for "${topic}".
            If specific info is missing, imply reasonable assumptions for this org type.
            Return ONLY the content text, no intro/outro.`;
            
            const res = await callOpenAI(prompt, null, null, null, true);
            if(res) document.getElementById(fieldId).value = res.replace(/"/g, '');
        }

        async function generateSWOT() {
            const orgType = document.getElementById('ai-input-org-type').value;
            const orgDesc = document.getElementById('ai-input-org-desc').value;
            if(!orgType) { alert('ระบุองค์กรก่อนครับ'); return; }

            const prompt = `Analyze SWOT for Organization: "${orgType}". Description: "${orgDesc}".
            IMPORTANT: Return ONLY valid JSON with keys: "strengths", "weaknesses", "opportunities", "threats".`;

            const res = await callOpenAI(prompt, 'btn-swot', 'btn-swot-text', 'Auto SWOT', false, { expectJson: true });
            if(res) {
                try {
                    const data = JSON.parse(res.replace(/```json|```/g, '').trim());
                    document.getElementById('input-strengths').value = data.strengths;
                    document.getElementById('input-weaknesses').value = data.weaknesses;
                    document.getElementById('input-opportunities').value = data.opportunities;
                    document.getElementById('input-threats').value = data.threats;
                } catch(e) { console.error(e); }
            }
        }

        async function generateVision() {
            // Updated to consider context from previous step
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Draft Vision & Strategic Goals based on the SWOT and Org info above.
            IMPORTANT: Return ONLY valid JSON with keys: "vision", "goals".`;
            
            // Reusing specific button logic manually since ID matches
            const res = await callOpenAI(prompt, 'btn-vision', 'btn-vision-text', 'Auto Draft Goals', false, { expectJson: true });
            if(res) {
                try {
                    const data = JSON.parse(res.replace(/```json|```/g, '').trim());
                    document.getElementById('input-vision').value = data.vision;
                    document.getElementById('input-goals').value = data.goals;
                } catch(e) {}
            }
        }

        async function generateBlueprint() {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Draft EA Blueprint.
            Requirements:
            - Business Architecture (Front/Core/Back) must be bullet points list.
            - Tech & Data must align with Goals.
            IMPORTANT: Return ONLY valid JSON with keys: "biz_front", "biz_core", "biz_back", "data", "tech".`;

            const res = await callOpenAI(prompt, 'btn-blueprint', 'btn-blueprint-text', 'Auto Blueprint (Bullet Points)', false, { expectJson: true });
            if(res) {
                try {
                    const data = JSON.parse(res.replace(/```json|```/g, '').trim());
                    document.getElementById('input-biz-front').value = data.biz_front;
                    document.getElementById('input-biz-core').value = data.biz_core;
                    document.getElementById('input-biz-back').value = data.biz_back;
                    document.getElementById('input-data-arch').value = data.data;
                    document.getElementById('input-tech-arch').value = data.tech;
                } catch(e) {}
            }
        }

        async function generateRoadmap() {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Create IT Roadmap based on Blueprint and Goals.
            IMPORTANT: Return ONLY valid JSON with keys: "short", "medium", "long".`;

            const res = await callOpenAI(prompt, 'btn-roadmap', 'btn-roadmap-text', 'Auto Roadmap', false, { expectJson: true });
            if(res) {
                try {
                    const data = JSON.parse(res.replace(/```json|```/g, '').trim());
                    document.getElementById('input-short-term').value = data.short;
                    document.getElementById('input-medium-term').value = data.medium;
                    document.getElementById('input-long-term').value = data.long;
                } catch(e) {}
            }
        }

        async function generateSecurity() {
            const context = collectContext();
            const prompt = `${context}
            ---
            Task: Analyze Cyber Security based on Tech Architecture.
            IMPORTANT: Return ONLY valid JSON with keys: "gov", "risk", "protect", "detect", "respond".`;

            const res = await callOpenAI(prompt, 'btn-security', 'btn-security-text', 'Auto Analyze', false, { expectJson: true });
            if(res) {
                try {
                    const data = JSON.parse(res.replace(/```json|```/g, '').trim());
                    document.getElementById('input-gov').value = data.gov;
                    document.getElementById('input-risk').value = data.risk;
                    document.getElementById('input-protect').value = data.protect;
                    document.getElementById('input-detect').value = data.detect;
                    document.getElementById('input-respond').value = data.respond;
                } catch(e) {}
            }
        }
    </script>
</body>
</html>
